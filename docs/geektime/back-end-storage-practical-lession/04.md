# 最小化账户系统
- user_id
- balance
- timestamp

# 为什么总对不上账
- 本质问题：冗余数据的一致性问题
- 需要记录账户流水
  * 流水ID
  * 交易金额
  * 交易时间
  * 交易双方系统、账户、交易单号等


## 账户流水设计原则
- 流水记录只能新增，一旦记录成功不允许修改和删除。由于正当原因需要取消一笔完成的交易，应再记录一笔取消交易的流水
- 流水号必须是递增的，需要用流水号来确定交易的先后顺序

# 使用数据库事务保证数据一致性
- 事务的ACID四个基本特性
  * 原子性 Atomic
     * 要么都成功，要没都失败
  * 一致性 Consistency
     * 保证督导的数据（交易和流水）总是一直的
  * 隔离性 Isolation
     * 未提交的事务不应该在其他事务中读取到
  * 持久性 Durability
     * 事务提交成功，数据一定会被持久化到磁盘中

# 理解事务的隔离级别
- 要完全满足ACID，所有的事务和SQL都只能串行执行，不能满足一般系统的要求
- 对账户系统和其他大多数交易系统来说，事务的原子性和持久性是必须要保证的，一致性和隔离性可做适当牺牲

## MySQL提供了四种隔离级别

| 隔离级别 | 脏读 <br> DR(Dirty Read) |不可重复读<br>NR(NonRepeatable Read) | 幻读<br>PR(Phantom Read)|
|----|----|-----|-----|
| 能读到未提交的数据<br>RU(READ-UNCOMMITTED) |Y|Y|Y|
|能读到已提交的数据<br>RC(READ-COMMITTED)|N|Y|Y|
|可重复读<br>RR(REPEATABLE-READ)|N|N|Y|
|串行执行<br>SERIALIZABLE|N|N|N|


## 兼顾并发、性能和数据一致性的交易实现
- RC和RR都是安全的

# 思考题
- 多个事务并发更新同一个账户时，RC和RR两种不同的隔离级别在行为上有什么不同
