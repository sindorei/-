# 如何更安全地做数据库备份和恢复
- 全量备份
  * mysqldump
  * 备份文件包含数据库总的所有数据，占用空间大
  * 备份过程中占用大量CPU、磁盘IO资源
  * 为保证数据一致性，还有可能锁表
  * 不能经常对数据库执行全量备份
  * 每天一次都已经是非常频繁了
  
- 增量备份
  * Binlog
     * `show variables like '%log_bin%'`确认是否开启Binlog功能
     * `show master status` 查看当前Binlog的状态
     

## 注意点
- 不要把所有的鸡蛋放在同一个篮子中，无论是全量还是binlog，都不要和数据库存放在同一个服务器上
- 在回放Binlog的时候，指定的起始时间可以比全量备份的实际稍微提前一点，确保全量备份之后的所有操作都在恢复的Binlog范围内，这样可以保证恢复的数据完整性
- 回放Binlog的操作具备幂等性的
  * 需设置Binlog的格式为ROW格式
  

# 配置MySQL HA实现高可用
- 数据恢复时间比较长，无需等到宕机才开始做恢复
- 实时地在主备数据库之间同步Binlog
- 主库做一次数据变更，生成一条binlog
- 把binlog复制到备用库并回放
- 一旦主库宕机，立即切换到备用库上继续提供服务
- 主从复制时序
  * 在主库的磁盘上写入binlog
  * 主库更新存储引擎中的数据
  * 给客户端返回成功响应
  * 主库把binlog复制到从库
  * 从库回放binlog，更新存储引擎中的数据
  
- 如果主库宕机并且主从存在延迟，切换到从库继续读写，可以保证业务的可用性，但是主从延迟这部分数据就丢失了

- 选择
  * 保证不丢数据，牺牲可用性，暂时停止服务，想办法把主库的binlog恢复到从库上之后再提供服务
  * 冒着丢失一些数据的风险，保证可用性，第一时间切换到从库继续提供服务
  * 既保证数据不丢失，还能做到高可用
     * 需要牺牲一些性能，开启同步复制
     * mysql主库会等数据成功复制到从库之后，再给客户端返回响应
     

- 对比
|方案|高可用|可能丢失数据|性能|
|---|---|---|---|
|一主一从<br>异步复制，手动切换|否|可控|好|
|一主一从<br>异步复制，自动切换|是|是|好|
|一主二从<br>同步复制，自动切换|是|否|差|