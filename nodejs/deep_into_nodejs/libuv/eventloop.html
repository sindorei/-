<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>libuv 事件循环 | 笔记</title><meta name="description" content="学习及练习的记录">
    <link rel="preload" href="/note/assets/style-BYxJ5vVe.css" as="style"><link rel="stylesheet" href="/note/assets/style-BYxJ5vVe.css">
    <link rel="modulepreload" href="/note/assets/app-LHpjaFTr.js"><link rel="modulepreload" href="/note/assets/eventloop.html-_2UGpvb8.js">
    <link rel="prefetch" href="/note/assets/index.html-CRKJAktu.js" as="script"><link rel="prefetch" href="/note/assets/编程语言的设计与实现.html-DMqrpBQ5.js" as="script"><link rel="prefetch" href="/note/assets/game.html-BpAPjRzA.js" as="script"><link rel="prefetch" href="/note/assets/go.html-DVSc15Kw.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BoNoRfZV.js" as="script"><link rel="prefetch" href="/note/assets/object.html-CpQ6YJU-.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BzmysG6T.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CdhVk01G.js" as="script"><link rel="prefetch" href="/note/assets/base_command.html-CHIvgGjv.js" as="script"><link rel="prefetch" href="/note/assets/docker_file.html-B5BYohMD.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CTdpb_rx.js" as="script"><link rel="prefetch" href="/note/assets/nodejs_image.html-DZicQK8S.js" as="script"><link rel="prefetch" href="/note/assets/git.html-CwBwNumC.js" as="script"><link rel="prefetch" href="/note/assets/http.html-CO9DwlcH.js" as="script"><link rel="prefetch" href="/note/assets/01.html-D08vSd6w.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CNuxsu-u.js" as="script"><link rel="prefetch" href="/note/assets/flex.html-DeYvkDAP.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DAiJKrDV.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CC79gBXK.js" as="script"><link rel="prefetch" href="/note/assets/ssr.html-CzWTTslj.js" as="script"><link rel="prefetch" href="/note/assets/vue3.html-BkjS9Z6u.js" as="script"><link rel="prefetch" href="/note/assets/01.html-BGyc60LY.js" as="script"><link rel="prefetch" href="/note/assets/02.html-D403JbXn.js" as="script"><link rel="prefetch" href="/note/assets/03.html-CGD6-qXW.js" as="script"><link rel="prefetch" href="/note/assets/04.html-PTAWabi_.js" as="script"><link rel="prefetch" href="/note/assets/05.html-CWFDSO4R.js" as="script"><link rel="prefetch" href="/note/assets/06.html-Ge6hEPSP.js" as="script"><link rel="prefetch" href="/note/assets/07.html-DG337sUc.js" as="script"><link rel="prefetch" href="/note/assets/08.html-CXQlh6qu.js" as="script"><link rel="prefetch" href="/note/assets/09.html-DobF94Gq.js" as="script"><link rel="prefetch" href="/note/assets/10.html-V02h8t29.js" as="script"><link rel="prefetch" href="/note/assets/11.html-Cxoqw4eS.js" as="script"><link rel="prefetch" href="/note/assets/12.html-YwJ00UTC.js" as="script"><link rel="prefetch" href="/note/assets/13.html-C4l31hYp.js" as="script"><link rel="prefetch" href="/note/assets/14.html-DBw4HV5O.js" as="script"><link rel="prefetch" href="/note/assets/15.html-DFEadcEY.js" as="script"><link rel="prefetch" href="/note/assets/16.html-BiiDI-MZ.js" as="script"><link rel="prefetch" href="/note/assets/17.html-CjzgDSV0.js" as="script"><link rel="prefetch" href="/note/assets/23.html-p-unLygU.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DGGZ1YGN.js" as="script"><link rel="prefetch" href="/note/assets/index.html-l-1l6LtJ.js" as="script"><link rel="prefetch" href="/note/assets/ap.html-CnmIQwyq.js" as="script"><link rel="prefetch" href="/note/assets/basic_sentence.html-CHMQ4J1P.js" as="script"><link rel="prefetch" href="/note/assets/clause.html-DDuuROBl.js" as="script"><link rel="prefetch" href="/note/assets/difference.html-CsOpK_XV.js" as="script"><link rel="prefetch" href="/note/assets/english_grammar_system.html-C8Go9I1E.js" as="script"><link rel="prefetch" href="/note/assets/noun.html-C9hRA14e.js" as="script"><link rel="prefetch" href="/note/assets/noun_phrase.html-DWz5xJO7.js" as="script"><link rel="prefetch" href="/note/assets/other.html-Bxlzxm-F.js" as="script"><link rel="prefetch" href="/note/assets/part_of_speech.html-BdGvDch7.js" as="script"><link rel="prefetch" href="/note/assets/phonetic_symbol.html-COKk3LiF.js" as="script"><link rel="prefetch" href="/note/assets/pronunciation_respelling.html-CASSzY-d.js" as="script"><link rel="prefetch" href="/note/assets/spoken_english.html-9A11oUFP.js" as="script"><link rel="prefetch" href="/note/assets/tense.html-Bp6DLOFz.js" as="script"><link rel="prefetch" href="/note/assets/vedios.html-CZFUZ8uU.js" as="script"><link rel="prefetch" href="/note/assets/word.html-sCscP_by.js" as="script"><link rel="prefetch" href="/note/assets/yinxingyi.html-Dz9DHIDO.js" as="script"><link rel="prefetch" href="/note/assets/zhangdaozhen.html-qGrFL9y7.js" as="script"><link rel="prefetch" href="/note/assets/bootstrap.html-B7goD2y1.js" as="script"><link rel="prefetch" href="/note/assets/dns.html-BtlwnnRk.js" as="script"><link rel="prefetch" href="/note/assets/file.html-DdTHP9HO.js" as="script"><link rel="prefetch" href="/note/assets/file_watch.html-CAVAmcLY.js" as="script"><link rel="prefetch" href="/note/assets/http.html-BrsbBXzu.js" as="script"><link rel="prefetch" href="/note/assets/index.html-ma5b5YJ4.js" as="script"><link rel="prefetch" href="/note/assets/memory.html-BBJmuRQo.js" as="script"><link rel="prefetch" href="/note/assets/module.html-DDdLXPNq.js" as="script"><link rel="prefetch" href="/note/assets/process.html-WBKE4Y4I.js" as="script"><link rel="prefetch" href="/note/assets/runtime.html-BLnJGDB_.js" as="script"><link rel="prefetch" href="/note/assets/setImmediate.html-DCBPJllt.js" as="script"><link rel="prefetch" href="/note/assets/tcp.html-Tzei2pG2.js" as="script"><link rel="prefetch" href="/note/assets/tcp_server_client.html-PlTwphfT.js" as="script"><link rel="prefetch" href="/note/assets/thread.html-pxQtUnzX.js" as="script"><link rel="prefetch" href="/note/assets/udp.html-CG1Hylul.js" as="script"><link rel="prefetch" href="/note/assets/unix_fd.html-CGjgL0dh.js" as="script"><link rel="prefetch" href="/note/assets/curl.html-CiO5vNwi.js" as="script"><link rel="prefetch" href="/note/assets/index.html-D8kuWLtK.js" as="script"><link rel="prefetch" href="/note/assets/singleton.html-BZZtufAV.js" as="script"><link rel="prefetch" href="/note/assets/command.html-Dub5Hj_m.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DSKs7BF_.js" as="script"><link rel="prefetch" href="/note/assets/index.html-C-sKCQde.js" as="script"><link rel="prefetch" href="/note/assets/11-20.html-DpEQDb6H.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CW1ro9zz.js" as="script"><link rel="prefetch" href="/note/assets/control.html-DbrYfu72.js" as="script"><link rel="prefetch" href="/note/assets/coroutine.html-CXgFu5Kg.js" as="script"><link rel="prefetch" href="/note/assets/error_except.html-XpaplLQ7.js" as="script"><link rel="prefetch" href="/note/assets/function.html-BYaXKKOL.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BQYErj4Q.js" as="script"><link rel="prefetch" href="/note/assets/module.html-DuJWV5-u.js" as="script"><link rel="prefetch" href="/note/assets/operator.html-Bl8Ll6sn.js" as="script"><link rel="prefetch" href="/note/assets/types.html-Eo9QZ4HV.js" as="script"><link rel="prefetch" href="/note/assets/class.html-91Gr4n-o.js" as="script"><link rel="prefetch" href="/note/assets/control_flow.html-BDFi5U9A.js" as="script"><link rel="prefetch" href="/note/assets/error_except.html-BJHPkAqX.js" as="script"><link rel="prefetch" href="/note/assets/function.html-sbFdXM7Z.js" as="script"><link rel="prefetch" href="/note/assets/index.html-C9i3pZ5V.js" as="script"><link rel="prefetch" href="/note/assets/module.html-CeUICiZp.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DSw-RJA-.js" as="script"><link rel="prefetch" href="/note/assets/start.html-DdNFeOvS.js" as="script"><link rel="prefetch" href="/note/assets/trpl.html-BtmJ3sJj.js" as="script"><link rel="prefetch" href="/note/assets/closure.html-CoNM3Qld.js" as="script"><link rel="prefetch" href="/note/assets/control_flow.html-5oKkjaOS.js" as="script"><link rel="prefetch" href="/note/assets/function.html-BAz4Sybn.js" as="script"><link rel="prefetch" href="/note/assets/index.html-D9utc7LP.js" as="script"><link rel="prefetch" href="/note/assets/operator.html-BIfws0KF.js" as="script"><link rel="prefetch" href="/note/assets/types.html-DZ1oI1e1.js" as="script"><link rel="prefetch" href="/note/assets/index.html-Bmceai8b.js" as="script"><link rel="prefetch" href="/note/assets/introduction.html-BEwqBwa_.js" as="script"><link rel="prefetch" href="/note/assets/bem.html-BscxAu2c.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DuSoPzyE.js" as="script"><link rel="prefetch" href="/note/assets/index.html-Dh6Ek41Y.js" as="script"><link rel="prefetch" href="/note/assets/code_spliting.html-Dj5pKKWS.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DcdBaI7M.js" as="script"><link rel="prefetch" href="/note/assets/tapable.html-DvpxAFCy.js" as="script"><link rel="prefetch" href="/note/assets/upgrade.html-CaJRu46c.js" as="script"><link rel="prefetch" href="/note/assets/index.html-B9menBKR.js" as="script"><link rel="prefetch" href="/note/assets/1.html-BTh8slHL.js" as="script"><link rel="prefetch" href="/note/assets/2.html-ItJLJwEM.js" as="script"><link rel="prefetch" href="/note/assets/3.html-7uCZe3p0.js" as="script"><link rel="prefetch" href="/note/assets/4.html-bq3pIVs0.js" as="script"><link rel="prefetch" href="/note/assets/index.html-ZMjTc9x_.js" as="script"><link rel="prefetch" href="/note/assets/data_struct.html-BuYtyN7t.js" as="script"><link rel="prefetch" href="/note/assets/libuv_js.html-CAO1XwO_.js" as="script"><link rel="prefetch" href="/note/assets/stream.html-CRD2yEUX.js" as="script"><link rel="prefetch" href="/note/assets/thread.html-CtgZ_SME.js" as="script"><link rel="prefetch" href="/note/assets/index.html-kRfWoiyf.js" as="script"><link rel="prefetch" href="/note/assets/qml_syntax.html-J-OJ77lS.js" as="script"><link rel="prefetch" href="/note/assets/404.html-DNCO1rp7.js" as="script"><link rel="prefetch" href="/note/assets/setupDevtools-7MC2TMWH-C61GSS5L.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/note/"><!----><span class="vp-site-name" aria-hidden="true">笔记</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><!----><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">深入剖析 Node.js 底层原理 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item active">libuv <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/nodejs/deep_into_nodejs/libuv/data_struct.html" aria-label="libuv数据结构与通用逻辑"><!---->libuv数据结构与通用逻辑<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/note/nodejs/deep_into_nodejs/libuv/eventloop.html" aria-label="libuv 事件循环"><!---->libuv 事件循环<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="libuv-事件循环" tabindex="-1"><a class="header-anchor" href="#libuv-事件循环"><span>libuv 事件循环</span></a></h1><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">EventSystem</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 需要处理的任务队列</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 标记是否需要退出事件循环</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 有任务时调用该函数&quot;唤醒&quot; await</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 没有任务时，事件循环的进入&quot;阻塞&quot;状态</span></span>
<span class="line">    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 记录 resolve，可能在睡眠期间有任务到来，则需要提前唤醒</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">wakeup</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 停止事件循环，如果正在&quot;阻塞&quot;，则&quot;唤醒它&quot;</span></span>
<span class="line">    <span class="token function">setStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 生产任务</span></span>
<span class="line">    <span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>wakeup <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 处理任务队列</span></span>
<span class="line">    <span class="token function">handleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 本轮事件循环的回调中加入的任务，下一轮事件循环再处理，防止其他任务没有机会处理</span></span>
<span class="line">        <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> func <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 事件循环的实现</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 如果 stop 等于 1 则退出事件循环</span></span>
<span class="line">        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 处理任务，可能没有任务需要处理</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 处理任务过程中如果设置了 stop 标记则退出事件循环</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stop <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">// 没有任务了，进入睡眠</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 退出前可能还有任务没处理，处理完再退出</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 新建一个事件循环系统</span></span>
<span class="line"><span class="token keyword">const</span> eventSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 启动前生成的任务</span></span>
<span class="line">eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 模拟定时生成一个任务</span></span>
<span class="line"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;3&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        eventSystem<span class="token punctuation">.</span><span class="token function">setStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 启动事件循环</span></span>
<span class="line">eventSystem<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 启动后生成的任务</span></span>
<span class="line">eventSystem<span class="token punctuation">.</span><span class="token function">enQueue</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上是一个事件循环的demo，具备了事件循环的一些核心功能：</p><ol><li>事件循环的整体架构是一个 while 循环。</li><li>定义任务类型和队列，这里只有一种任务类型和一个队列，比如 Node.js 里有好几种，每种类型的任务有不同的作用。</li><li>没有任务的时候怎么处理：进入阻塞状态，而不是靠忙轮询。</li></ol><p>第 3 点是事件循环系统中非常重要的逻辑，因为事件循环属于生产者 / 消费者模式，任务队列中不可能一直都有任务需要处理，这就意味着生产任务可以是一个异步的过程，所以事件循环系统就需要有一种等待 / 唤醒机制。但这会带来两个问题：如何实现等待 / 唤醒机制？什么时候需要退出？</p><p>这和具体的业务场景有关，在该事件循环中，没有任务的时候就会一直等待而不是退出。除非用户手动执行 setStop 退出。而在 Node.js 中，如果没有 actived 状态的 handle 和 request 并且 close 阶段没有任务时就会自动退出，具体可以参考 uv__loop_alive 函数。那如何实现等待 / 唤醒呢？这里使用的是 await Promise 来模拟睡眠达到等待的效果，而在 Libuv 中，通过在 Poll IO 阶段使用操作系统的事件驱动模块实现等待 / 唤醒机制。</p><h2 id="其他软件的事件循环" tabindex="-1"><a class="header-anchor" href="#其他软件的事件循环"><span>其他软件的事件循环</span></a></h2><h3 id="nginx-1-23-1" tabindex="-1"><a class="header-anchor" href="#nginx-1-23-1"><span>Nginx 1.23.1</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ngx_worker_process_cycle</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 事件循环</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 是否需要退出</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>ngx_exiting<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 是否还有定时器节点，有的话需要先处理再退出</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ngx_event_no_timers_left</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> NGX_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">ngx_worker_process_exit</span><span class="token punctuation">(</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 处理定时器和其他事件</span></span>
<span class="line">        <span class="token function">ngx_process_events_and_timers</span><span class="token punctuation">(</span>cycle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ngx_worker_process_cycle 是在子进程里执行的函数，在一个 for 循环中不断调用 ngx_process_events_and_timers，接着看一下 ngx_process_events_and_timers。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">ngx_process_events_and_timers</span><span class="token punctuation">(</span><span class="token class-name">ngx_cycle_t</span> <span class="token operator">*</span>cycle<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 找到最快到期的定时器</span></span>
<span class="line">    timer <span class="token operator">=</span> <span class="token function">ngx_event_find_timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 调用事件驱动模块等待就绪事件或者定时器超时</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">ngx_process_events</span><span class="token punctuation">(</span>cycle<span class="token punctuation">,</span> timer<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 处理事件</span></span>
<span class="line">    <span class="token function">ngx_event_process_posted</span><span class="token punctuation">(</span>cycle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ngx_posted_accept_events<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 处理过期的定时器</span></span>
<span class="line">    <span class="token function">ngx_event_expire_timers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 处理事件</span></span>
<span class="line">    <span class="token function">ngx_event_process_posted</span><span class="token punctuation">(</span>cycle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ngx_posted_events<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="redis-0-1" tabindex="-1"><a class="header-anchor" href="#redis-0-1"><span>Redis 0.1</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">aeMain</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    eventLoop<span class="token operator">-&gt;</span>stop <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventLoop<span class="token operator">-&gt;</span>stop<span class="token punctuation">)</span></span>
<span class="line">        <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> AE_ALL_EVENTS<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> maxfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> numfd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> processed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    fd_set rfds<span class="token punctuation">,</span> wfds<span class="token punctuation">,</span> efds<span class="token punctuation">;</span></span>
<span class="line">    aeFileEvent <span class="token operator">*</span>fe <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>fileEventHead<span class="token punctuation">;</span></span>
<span class="line">    aeTimeEvent <span class="token operator">*</span>te<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 初始化变量</span></span>
<span class="line">    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rfds<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wfds<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>efds<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 处理文件事件</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_FILE_EVENTS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span>fe <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 根据需要处理的事件，设置对应的变量对应的位</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> AE_READABLE<span class="token punctuation">)</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rfds<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> AE_WRITABLE<span class="token punctuation">)</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wfds<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>mask <span class="token operator">&amp;</span> AE_EXCEPTION<span class="token punctuation">)</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span>fe<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>efds<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 记录最大文件描述符 select 的时候需要用</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxfd <span class="token operator">&lt;</span> fe<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span> maxfd <span class="token operator">=</span> fe<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span></span>
<span class="line">            numfd<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">            fe <span class="token operator">=</span> fe<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 有文件事件需要处理</span></span>
<span class="line">    <span class="token comment">// 或者没有文件事件需要处理但是有 time 事件并且没有设置 AE_DONT_WAIT 标记</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>numfd <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">int</span> retval<span class="token punctuation">;</span></span>
<span class="line">        aeTimeEvent <span class="token operator">*</span>shortest <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">,</span> <span class="token operator">*</span>tvp<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 有 time 事件需要处理，并且没有设置 AE_DONT_WAIT 标记，则 select 可能会定时阻塞（如果有time节点的话）</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">// 找出最快到期的节点</span></span>
<span class="line">            shortest <span class="token operator">=</span> <span class="token function">aeSearchNearestTimer</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 有待到期的time节点</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>shortest<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 计算超时时间</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 没有到期的time节点</span></span>
<span class="line">            <span class="token comment">// 设置了AE_DONT_WAIT，则不会阻塞在select</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_DONT_WAIT<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                tv<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> tv<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">                tvp <span class="token operator">=</span> <span class="token operator">&amp;</span>tv<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 一直阻塞直到有事件发生</span></span>
<span class="line">                tvp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* wait forever */</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 调用事件驱动模块等待时间触发或者超时</span></span>
<span class="line">        retval <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>maxfd<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wfds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>efds<span class="token punctuation">,</span> tvp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 有事件触发则处理</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            fe <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>fileEventHead<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">while</span><span class="token punctuation">(</span>fe <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 执行回调</span></span>
<span class="line">                fe<span class="token operator">-&gt;</span><span class="token function">fileProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> fe<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> fe<span class="token operator">-&gt;</span>clientData<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 处理time事件</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> AE_TIME_EVENTS<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        te <span class="token operator">=</span> eventLoop<span class="token operator">-&gt;</span>timeEventHead<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span><span class="token punctuation">(</span>te<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// 获取当前时间</span></span>
<span class="line">            <span class="token function">aeGetTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now_sec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now_ms<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 到期了</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>now_sec <span class="token operator">&gt;</span> te<span class="token operator">-&gt;</span>when_sec <span class="token operator">||</span></span>
<span class="line">                <span class="token punctuation">(</span>now_sec <span class="token operator">==</span> te<span class="token operator">-&gt;</span>when_sec <span class="token operator">&amp;&amp;</span> now_ms <span class="token operator">&gt;=</span> te<span class="token operator">-&gt;</span>when_ms<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// 执行回调</span></span>
<span class="line">                te<span class="token operator">-&gt;</span><span class="token function">timeProc</span><span class="token punctuation">(</span>eventLoop<span class="token punctuation">,</span> id<span class="token punctuation">,</span> te<span class="token operator">-&gt;</span>clientData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                te <span class="token operator">=</span> te<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 处理的事件个数</span></span>
<span class="line">    <span class="token keyword">return</span> processed<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="libuv-的事件循环" tabindex="-1"><a class="header-anchor" href="#libuv-的事件循环"><span>Libuv 的事件循环</span></a></h2><p>Libuv 事件循环具体在 uv_run 函数中实现。uv_run 中执行 while 循环，然后串行处理各种阶段（phase）的事件回调，所以当一个任务执行时间过长，就会影响后面任务的执行，导致事件循环延迟过高。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_run</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> uv_run_mode mode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> timeout<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> r<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> ran_pending<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loop<span class="token operator">-&gt;</span>stop_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 更新当前时间，每轮事件循环会缓存这个时间，避免过多系统调用损耗性能</span></span>
<span class="line">        <span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行定时器回调</span></span>
<span class="line">        <span class="token function">uv__run_timers</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行 pending 回调</span></span>
<span class="line">        <span class="token function">uv__run_pending</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 继续执行各种队列</span></span>
<span class="line">        <span class="token function">uv__run_idle</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">uv__run_prepare</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 计算 Poll IO 阻塞时间</span></span>
<span class="line">        timeout <span class="token operator">=</span> <span class="token function">uv_backend_timeout</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// Poll IO timeout是 epoll_wait 的等待时间</span></span>
<span class="line">        <span class="token function">uv__io_poll</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 继续执行各种队列</span></span>
<span class="line">        <span class="token function">uv__run_check</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">uv__run_closing_handles</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 是否还有活跃任务，有则继续下一轮事件循环</span></span>
<span class="line">        r <span class="token operator">=</span> <span class="token function">uv__loop_alive</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> r<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">uv__loop_alive</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">uv__has_active_handles</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">         <span class="token function">uv__has_active_reqs</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">         loop<span class="token operator">-&gt;</span>closing_handles <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="prepare、check、idle-阶段" tabindex="-1"><a class="header-anchor" href="#prepare、check、idle-阶段"><span>prepare、check、idle 阶段</span></a></h3><p>prepare、check、idle 阶段的实现是一样的，只是执行时机不一样。Libuv 分为 handle 和 request。而 idle 阶段的任务是属于 handle。下面我们通过一个例子，看看 idle 阶段的任务是如何创建和处理的。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;uv.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">idle_cb</span><span class="token punctuation">(</span><span class="token class-name">uv_idle_t</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;idle callback\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">uv_idle_t</span> idle<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 初始化</span></span>
<span class="line">    <span class="token function">uv_idle_init</span><span class="token punctuation">(</span><span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>idle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 启动，每轮事件循环都会执行 idle_cb</span></span>
<span class="line">    <span class="token function">uv_idle_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>idle<span class="token punctuation">,</span> idle_cb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv_run</span><span class="token punctuation">(</span><span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UV_RUN_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码中，Libuv 会在每一轮事件循环的 idle 阶段执行回调 idle_cb。我们分析一下这个过程。使用前，首先定义一个 uv_idle_t 结构体，然后执行 uv_idle_init 进行 handle 的初始化。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_idle_init</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token class-name">uv_idle_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">uv__handle_init</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">,</span> UV_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>idle_cb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_idle_init 函数主要是做一些初始化操作，继续看 start 函数。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_idle_start</span><span class="token punctuation">(</span><span class="token class-name">uv_idle_t</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> uv_idle_cb cb<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 如果已经执行过 start 函数则直接返回</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uv__is_active</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>cb <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span> UV_EINVAL<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">QUEUE_INSERT_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>loop<span class="token operator">-&gt;</span>idle_handles<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>idle_cb <span class="token operator">=</span> cb<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv__handle_start</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_idle_start 用于设置回调，把 handle 插入事件循环中的 idle_handles 队列，idle_handles 则保存了 idle 阶段的任务。接着执行 uv_run 开始事件循环，在事件循环的 idle 阶段会逐个执行里面的节点的回调。我们看看 Libuv 在事件循环的 idle 阶段是如何处理的。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__run_idle</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">uv_prepare_t</span><span class="token operator">*</span> h<span class="token punctuation">;</span></span>
<span class="line">    QUEUE queue<span class="token punctuation">;</span></span>
<span class="line">    QUEUE<span class="token operator">*</span> q<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/*</span>
<span class="line">        把该类型对应的队列中所有节点摘下来挂载到 queue 变量，</span>
<span class="line">        相当于清空 idle_handles 队列，因为如果直接遍历</span>
<span class="line">        idle_handles 队列，在执行回调的时候如果一直往 idle_handles</span>
<span class="line">        队列加节点，会导致下面的 while 循环无法退出。</span>
<span class="line">        先移除的话，新插入的节点在下一轮事件循环才会被处理。</span>
<span class="line">    */</span></span>
<span class="line">    <span class="token function">QUEUE_MOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>idle_handles<span class="token punctuation">,</span> <span class="token operator">&amp;</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 遍历队列，执行每个节点里面的函数</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 取下当前待处理的节点，即队列的头</span></span>
<span class="line">        q <span class="token operator">=</span> <span class="token function">QUEUE_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">/*</span>
<span class="line">            取得该节点对应的整个结构体的基地址，</span>
<span class="line">            即通过结构体成员取得结构体首地址</span>
<span class="line">        */</span></span>
<span class="line">        h <span class="token operator">=</span> <span class="token function">QUEUE_DATA</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token class-name">uv_idle_t</span><span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 把该节点移出当前队列</span></span>
<span class="line">        <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 重新插入原来的队列</span></span>
<span class="line">        <span class="token function">QUEUE_INSERT_TAIL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>idle_handles<span class="token punctuation">,</span> q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行回调函数</span></span>
<span class="line">        h<span class="token operator">-&gt;</span><span class="token function">idle_cb</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__run_idle 函数的逻辑很简单，就是逐个执行 idle_handles 队列的节点。不过有一个地方需要注意，节点被移出队列后，又执行 QUEUE_INSERT_TAIL 重新插入到队列了，所以这三个阶段的任务是每次事件循环都会被执行的。</p><p>虽然 idle、check、prepare 回调会在每一轮事件循环被执行，但是 idle 阶段比较特殊，当存在 idle 任务时，事件循环不会阻塞在 Poll IO 阶段，所以 idle 任务的回调会一直执行，而如果是 prepare 或 check 任务，事件循环会阻塞在 Poll IO 阶段，从 Poll IO 阶段返回时，才会继续执行 prepare 或 check 回调，比如下面的例子中，回调只会被执行一次。</p><p>设置Libuv 的运行模式是默认模式（UV_RUN_DEFAULT）。如果有 active 状态的 handle（idle 节点），事件循环是不会退出的，它会一直执行回调。如果要退出或者不需要执行 idle 队列的某个节点，只需要 uv_idle_stop 就可以了。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_idle_stop</span><span class="token punctuation">(</span><span class="token class-name">uv_idle_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">uv__is_active</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 把 handle 从 idle 队列中移除，但是还挂载到 handle_queue 中</span></span>
<span class="line">    <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 清除 active 标记位并且减去事件循环中 handle 的 active 数</span></span>
<span class="line">    <span class="token function">uv__handle_stop</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_idle_stop 会停止 uv_idle_t handle 并移出 idle 队列，但是不会把 handle 移出事件循环的 handle 队列，如果想把 handle 移出事件循环的 handle 队列，需要调用 uv_close，uv_close 除了调用 uv_idle_stop，还会把 handle 移出 handle 队列。</p><p>另外需要注意的是，虽然 idle、check、prepare 回调会在每一轮事件循环被执行，但是 idle 阶段比较特殊，当存在 idle 任务时，事件循环不会阻塞在 Poll IO 阶段，所以 idle 任务的回调会一直执行，而如果是 prepare 或 check 任务，事件循环会阻塞在 Poll IO 阶段，从 Poll IO 阶段返回时，才会继续执行 prepare 或 check 回调，比如下面的例子中，回调只会被执行一次。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;uv.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">prep_cb</span><span class="token punctuation">(</span><span class="token class-name">uv_prepare_t</span> <span class="token operator">*</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Prep callback\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">uv_prepare_t</span> prep<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv_prepare_init</span><span class="token punctuation">(</span><span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>prep<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv_prepare_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>prep<span class="token punctuation">,</span> prep_cb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 执行一次 prep_cb 然后进入阻塞状态</span></span>
<span class="line">    <span class="token function">uv_run</span><span class="token punctuation">(</span><span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UV_RUN_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="pending-阶段" tabindex="-1"><a class="header-anchor" href="#pending-阶段"><span>pending 阶段</span></a></h3><p>pending 阶段用于处理 Poll IO 阶段产生的一些回调，比如连接失败时的回调或者 UDP 数据发送结束的写回调。下面来看一个例子。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv__tcp_connect</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">do</span> <span class="token punctuation">{</span></span>
<span class="line">    errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 非阻塞式发起连接</span></span>
<span class="line">    r <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token function">uv__stream_fd</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">,</span> addr<span class="token punctuation">,</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 连接失败或还没成功</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINPROGRESS<span class="token punctuation">)</span> <span class="token comment">// 连接中的错误码</span></span>
<span class="line">      <span class="token punctuation">;</span> <span class="token comment">/* not an error */</span></span>
<span class="line">    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> ECONNREFUSED<span class="token punctuation">)</span></span>
<span class="line">      handle<span class="token operator">-&gt;</span>delayed_error <span class="token operator">=</span> <span class="token function">UV__ERR</span><span class="token punctuation">(</span>ECONNREFUSED<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">UV__ERR</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 产生 pending 任务</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>delayed_error<span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">uv__io_feed</span><span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>loop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>io_watcher<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__tcp_connect 调用 connect 函数以非阻塞方式发起 TCP 连接，当 connect 返回时，可能处于连接中或者失败，从代码中可以看到当 errno 是 ECONNREFUSED 时，Libuv 会执行 uv__io_feed 函数。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__io_feed</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">QUEUE_INSERT_TAIL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__io_feed 函数会把一个 IO 观察者插入到 pending 队列，从中也可以看到 pending 阶段是和 IO 相关的。接下来看一下 pending 阶段的处理。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">uv__run_pending</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  QUEUE<span class="token operator">*</span> q<span class="token punctuation">;</span></span>
<span class="line">  QUEUE pq<span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 把 pending_queue 队列的节点移到 pq，清空 pending_queue</span></span>
<span class="line">  <span class="token function">QUEUE_MOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pq<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 遍历 pq 队列</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 取出当前第一个需要处理的节点</span></span>
<span class="line">    q <span class="token operator">=</span> <span class="token function">QUEUE_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pq<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 把当前需要处理的节点移出队列</span></span>
<span class="line">    <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 重置一下 prev 和 next 指针</span></span>
<span class="line">    <span class="token function">QUEUE_INIT</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    w <span class="token operator">=</span> <span class="token function">QUEUE_DATA</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token punctuation">,</span> pending_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 执行回调</span></span>
<span class="line">    w<span class="token operator">-&gt;</span><span class="token function">cb</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token punctuation">,</span> POLLOUT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pending 阶段的处理逻辑比较简单，就是遍历队列，然后执行每个节点的回调，这里需要注意的是，回调的入参是 loop、IO 观察者和可写事件</p><h3 id="close-阶段" tabindex="-1"><a class="header-anchor" href="#close-阶段"><span>close 阶段</span></a></h3><p>close 是 Libuv 每轮事件循环中最后的一个阶段。对于一个 handle，有四个通用的操作函数，分别是 init、start、stop 和 close。init 和 start 比较好理解，那么 stop 和 close 有什么区别呢？</p><p>stop 通常意味着这个 handle 处于暂停状态，后续还可以调用 start 重新激活，同时还挂载在事件循环的 handle 队列。比如可以使用 uv_timer_stop 停止一个定时器，然后再执行 uv_timer_start 重启这个定时器。但是 close 意味着这个 handle 已经被关闭了，不再重新使用，同时也会被移出事件循环的 handle 队列。另外， close 操作支持传入一个回调，这个回调会在 close 阶段被执行，比如用于释放动态申请的内存。close 阶段的任务由 uv_close 产生。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv_close</span><span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> uv_close_cb close_cb<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 正在关闭，但是还没执行回调等后置操作</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> UV_HANDLE_CLOSING<span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>close_cb <span class="token operator">=</span> close_cb<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 根据 handle 类型执行不同的操作，通常是 stop 这个 handle</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> UV_PREPARE<span class="token operator">:</span></span>
<span class="line">            <span class="token function">uv__prepare_close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uv_prepare_t</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">case</span> UV_CHECK<span class="token operator">:</span></span>
<span class="line">            <span class="token function">uv__check_close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uv_check_t</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">uv__make_close_pending</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_close 设置 handle 的回调和状态，然后根据 handle 类型调对应的 close 函数，一般就是 stop 这个 handle。比如 prepare 的 close 函数：</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__prepare_close</span><span class="token punctuation">(</span><span class="token class-name">uv_prepare_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">uv_prepare_stop</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，执行 uv__make_close_pending 以头插法往 close 队列插入一个任务。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 头插法插入 close 队列，在 close 阶段被执行</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">uv__make_close_pending</span><span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>next_closing <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>loop<span class="token operator">-&gt;</span>closing_handles<span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>loop<span class="token operator">-&gt;</span>closing_handles <span class="token operator">=</span> handle<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后，在 close 阶段逐个处理。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">uv__run_closing_handles</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">uv_handle_t</span><span class="token operator">*</span> p<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uv_handle_t</span><span class="token operator">*</span> q<span class="token punctuation">;</span></span>
<span class="line">    p <span class="token operator">=</span> loop<span class="token operator">-&gt;</span>closing_handles<span class="token punctuation">;</span></span>
<span class="line">    loop<span class="token operator">-&gt;</span>closing_handles <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        q <span class="token operator">=</span> p<span class="token operator">-&gt;</span>next_closing<span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">uv__finish_close</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        p <span class="token operator">=</span> q<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 执行 close 阶段的回调</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">uv__finish_close</span><span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> UV_HANDLE_CLOSED<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">    <span class="token function">uv__handle_unref</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 移出 handle 队列</span></span>
<span class="line">    <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>handle_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 执行回调</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>close_cb<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        handle<span class="token operator">-&gt;</span><span class="token function">close_cb</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面看一个使用了uv_close 的例子（代码来自 Libuv 中的文件监听模块，省略部分代码）</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_fs_poll_start</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    </span>
<span class="line">    <span class="token comment">// 分配一块堆内存</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">poll_ctx</span><span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token function">uv__calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ctx<span class="token punctuation">)</span> <span class="token operator">+</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 保存到 handle 中</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>poll_ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_fs_poll_start 用于执行开始监听文件的操作，它在 handle 里挂载了一个在堆上分配的结构体，当结束监听的时候，需要释放掉这块内存。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_fs_poll_stop</span><span class="token punctuation">(</span><span class="token class-name">uv_fs_poll_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">poll_ctx</span><span class="token operator">*</span> ctx<span class="token punctuation">;</span></span>
<span class="line">    ctx <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>poll_ctx<span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>poll_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv_close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ctx<span class="token operator">-&gt;</span>timer_handle<span class="token punctuation">,</span> timer_close_cb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_fs_poll_stop 通过 uv_close 函数关闭 handle，并传入了回调 timer_close_cb，所以在 close 阶段就会执行 timer_close_cb。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 释放上下文结构体的内存</span></span>
<span class="line"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">timer_close_cb</span><span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">uv__free</span><span class="token punctuation">(</span><span class="token function">container_of</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">poll_ctx</span><span class="token punctuation">,</span> timer_handle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，最后在 close 阶段释放这块内存。</p><h3 id="timer-阶段" tabindex="-1"><a class="header-anchor" href="#timer-阶段"><span>timer 阶段</span></a></h3><p>timer 阶段是用于实现定时器的，定时器是大多数基于事件驱动架构的软件需要实现的部分。因为 V8 中没有提供定时器的功能，在前端时是由浏览器实现的，而在 Node.js 里，定时器由 Libuv 实现。</p><p>定时器的实现原理很简单，主要是借助事件驱动模块的阻塞时间来实现，通常就是维护了一个数据结构，然后把最快到期的时间设置为事件驱动模块的阻塞时间，如果一定时间内没有其他事件触发，那么进程就会从事件驱动模块中返回，从而处理定时器。但是因为定时器使用非常频繁，所以如何实现一个高性能的定时器是需要重点考虑的事情。</p><p>Libuv 中，在底层里面维护了一个最小堆，每个定时节点就是堆里面的一个节点，越早超时的节点就在越上面。等到定时器阶段的时候， Libuv 就会从上往下去遍历这个最小堆判断当前节点有没有超时，如果碰到没有到期的节点，那么后面节点也不需要去判断了，因为根据最小堆的性质，最早到期的节点都没有到期，那么它后面节点显然也不会到期。如果当前节点到期了，那么就会执行它的回调，并且把它移出这个最小堆。</p><p>定时器的概念是超时后会执行一个回调，如果用户需要周期性执行一个回调，例如 Node.js setInterval 的这种场景，就可以给这个节点设置了repeat 标记，那么这个节点每次超时执行完回调后，就会被重新插入到最小堆中，等待下一次的超时。有意思的是，Libuv 的定时器支持 timeout1 后触发第一次超时，后续每隔 timeout2 触发一次超时。整体结构如下图所示。</p><p>定时器的使用：</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">v_timer_t</span> once<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv_timer_init</span><span class="token punctuation">(</span><span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>once<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 超时后执行 once_cb，0 表示只执行一次回调，设置为 n 代表第一次超时后，下次超时时间</span></span>
<span class="line">    <span class="token function">uv_timer_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>once<span class="token punctuation">,</span> once_cb<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">uv_run</span><span class="token punctuation">(</span><span class="token function">uv_default_loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UV_RUN_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 初始化uv_timer_t结构体</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">uv_timer_init</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token class-name">uv_timer_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">uv__handle_init</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uv_handle_t</span><span class="token operator">*</span><span class="token punctuation">)</span>handle<span class="token punctuation">,</span> UV_TIMER<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>timer_cb <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">    handle<span class="token operator">-&gt;</span>repeat <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_timer_init 函数和其他阶段的 init 函数一样，用于初始化 handle 的一些字段。接着看 start 函数，该函数是启动一个定时器（省略部分代码）。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 启动一个计时器</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">uv_timer_start</span><span class="token punctuation">(</span><span class="token class-name">uv_timer_t</span><span class="token operator">*</span> handle<span class="token punctuation">,</span></span>
<span class="line">                   uv_timer_cb cb<span class="token punctuation">,</span></span>
<span class="line">                   <span class="token class-name">uint64_t</span> timeout<span class="token punctuation">,</span></span>
<span class="line">                   <span class="token class-name">uint64_t</span> repeat<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">uint64_t</span> clamped_timeout<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 重新执行 start 的时候先把之前的停掉</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">uv__is_active</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">uv_timer_stop</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 超时时间，为绝对值</span></span>
<span class="line">        clamped_timeout <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>loop<span class="token operator">-&gt;</span>time <span class="token operator">+</span> timeout<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 初始化回调，超时时间，是否重复计时，赋予一个独立无二的 id</span></span>
<span class="line">        handle<span class="token operator">-&gt;</span>timer_cb <span class="token operator">=</span> cb<span class="token punctuation">;</span></span>
<span class="line">        handle<span class="token operator">-&gt;</span>timeout <span class="token operator">=</span> clamped_timeout<span class="token punctuation">;</span></span>
<span class="line">        handle<span class="token operator">-&gt;</span>repeat <span class="token operator">=</span> repeat<span class="token punctuation">;</span></span>
<span class="line">        handle<span class="token operator">-&gt;</span>start_id <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>loop<span class="token operator">-&gt;</span>timer_counter<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 插入最小堆</span></span>
<span class="line">        <span class="token function">heap_insert</span><span class="token punctuation">(</span><span class="token function">timer_heap</span><span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>loop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">heap_node</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>heap_node<span class="token punctuation">,</span> timer_less_than<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 激活该 handle</span></span>
<span class="line">        <span class="token function">uv__handle_start</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_timer_start 函数首先初始化 handle 里的某些字段，包括超时回调，是否重复启动定时器，超时的绝对时间等，接着把 handle 节点插入到最小堆中，heap_insert 会根据该节点的超时时间动态调整最小堆，最后给这个 handle 打上标记，并激活这个handle。在 timer 阶段时就会判断有没有定时器超时，有则执行回调。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 找出已经超时的节点，并且执行里面的回调</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">uv__run_timers</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">heap_node</span><span class="token operator">*</span> heap_node<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uv_timer_t</span><span class="token operator">*</span> handle<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        heap_node <span class="token operator">=</span> <span class="token function">heap_min</span><span class="token punctuation">(</span><span class="token function">timer_heap</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>heap_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        handle <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>heap_node<span class="token punctuation">,</span> <span class="token class-name">uv_timer_t</span><span class="token punctuation">,</span> heap_node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 如果当前节点的时间大于当前时间则返回，说明后面的节点也没有超时</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>timeout <span class="token operator">&gt;</span> loop<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 移除该计时器节点</span></span>
<span class="line">        <span class="token function">uv_timer_stop</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 如果设置了 repeat 则重新插入最小堆，等待下次超时</span></span>
<span class="line">        <span class="token function">uv_timer_again</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 执行超时回调</span></span>
<span class="line">        handle<span class="token operator">-&gt;</span><span class="token function">timer_cb</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__run_timers 函数的逻辑就是遍历最小堆，找出当前超时的节点。因为最小堆的性质是父节点肯定比孩子小。所以如果找到一个节点，它没有超时，则后面的节点也不会超时。对于超时的节点就执行它的回调。执行完回调后，还有两个关键的操作：第一是 uv_timer_stop；第二是 uv_timer_again。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 停止一个计时器</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">uv_timer_stop</span><span class="token punctuation">(</span><span class="token class-name">uv_timer_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">uv__is_active</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 从最小堆中移除该计时器节点</span></span>
<span class="line">    <span class="token function">heap_remove</span><span class="token punctuation">(</span><span class="token function">timer_heap</span><span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>loop<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">heap_node</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>handle<span class="token operator">-&gt;</span>heap_node<span class="token punctuation">,</span> timer_less_than<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 清除激活状态和 handle 的 active 数减一</span></span>
<span class="line">    <span class="token function">uv__handle_stop</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv_timer_stop 把 handle 从二叉堆中删除。uv_timer_again 则是为了支持 setInterval 这种场景。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_timer_again</span><span class="token punctuation">(</span><span class="token class-name">uv_timer_t</span><span class="token operator">*</span> handle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 如果设置了 repeat 标记说明计时器是需要重复触发的</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>repeat<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 先把旧的计时器节点从最小堆中移除，然后再重新开启一个计时器</span></span>
<span class="line">        <span class="token function">uv_timer_stop</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">uv_timer_start</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> handle<span class="token operator">-&gt;</span>timer_cb<span class="token punctuation">,</span> handle<span class="token operator">-&gt;</span>repeat<span class="token punctuation">,</span> handle<span class="token operator">-&gt;</span>repeat<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果 handle 设置了 repeat 标记，则在该 handle 第一次超时后，每隔 repeat 毫秒就会继续执行超时回调。这就是 Node.js 里定时器的底层原理，但 Node.js 并不是每次调 setTimeout 的时候都往最小堆插入一个节点，因为这样会引起 JS 层和 C、C++ 层频繁通信，导致性能损毁。因此在 Node.js 里，只有一个关于 uv_timer_s 的 handle，它在 JS 层维护了一个数据结构，每次计算出最快到期节点的时间，然后修改 Libuv handle 的超时时间。</p><p>timer 阶段是依赖事件驱动模块实现的，因为事件驱动模块可能会引起线程阻塞，为了保证线程可以按时执行定时器的回调，事件驱动模块会定时阻塞，阻塞的时长就是最快到期的定时器节点的时长。</p><h3 id="poll-io-阶段" tabindex="-1"><a class="header-anchor" href="#poll-io-阶段"><span>Poll IO 阶段</span></a></h3><p>Poll IO 是 Libuv 最重要的一个阶段，可以说 Libuv 的驱动引擎。网络 IO、线程池完成任务、信号处理等回调都是在这个阶段处理的，所以这也是最复杂的一个阶段。这个阶段本质上是对各个操作系统事件驱动模块的封装，比如 Linux 的 epoll 和 MacOS 的 kqueue 等，这部分的技术也是大多数软件中用到的，所以也很通用。开始分析这个阶段之前，我们先了解一下 Poll IO 阶段最重要的数据结构 IO 观察者。</p><p>IO 观察者</p><p>IO 观察者是 Libuv 中的核心数据结构，本质上是封装了文件描述符、感兴趣的事件和回调的结构体。那它是如何作用于事件驱动模块的呢，我们下面详细分析。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">struct</span> <span class="token class-name">uv__io_s</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 事件触发后的回调</span></span>
<span class="line">    uv__io_cb cb<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 用于插入队列</span></span>
<span class="line">    <span class="token keyword">void</span><span class="token operator">*</span> pending_queue<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">void</span><span class="token operator">*</span> watcher_queue<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 保存当前感兴趣的事件，还没有同步的操作系统。每次设置时首先保存事件在这个字段，然后 Poll IO 阶段再操作事件驱动模块更新到操作系统</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pevents<span class="token punctuation">;</span> </span>
<span class="line">    <span class="token comment">// 保存更新到操作系统的事件，每次 Poll IO 阶段更新 pevents 的值到操作系统后就把 pevents 同步到 events</span></span>
<span class="line">    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> events<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 标记对哪个文件描述符的事件感兴趣</span></span>
<span class="line">    <span class="token keyword">int</span> fd<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Libuv 会维护一个 IO 观察者队列，根据 IO 观察者描述的信息，在Poll IO 阶段往底层的事件驱动模块注册相应的信息。当注册的事件触发时，IO 观察者的回调就会被执行。接下来看看 IO 观察者的一些操作。</p><p>初始化 IO 观察者</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__io_init</span><span class="token punctuation">(</span><span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">,</span> uv__io_cb cb<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">// 初始化队列，回调，需要监听的 fd  </span></span>
<span class="line">    <span class="token function">QUEUE_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token function">QUEUE_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    w<span class="token operator">-&gt;</span>cb <span class="token operator">=</span> cb<span class="token punctuation">;</span>  </span>
<span class="line">    w<span class="token operator">-&gt;</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>  </span>
<span class="line">    w<span class="token operator">-&gt;</span>events <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  </span>
<span class="line">    w<span class="token operator">-&gt;</span>pevents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  </span>
<span class="line"><span class="token punctuation">}</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pevents 表示应用当前感兴趣的事件，events 字段表示当前设置到操作系统的事件，因为应用设置感兴趣时是直接修改 pevents 的，但是这个信息并不会实时同步到操作系统，而是在 Poll IO 阶段才进行同步，所以需要两个字段记录，后面我们会看到它们具体的作用。</p><p>注册事件</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__io_start</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">// 设置当前感兴趣的事件，但还没有同步到操作系统，等到 Poll IO 阶段再同步  </span></span>
<span class="line">    w<span class="token operator">-&gt;</span>pevents <span class="token operator">|=</span> events<span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token comment">// 扩容 loop-&gt;watchers，如果需要的话</span></span>
<span class="line">    <span class="token function">maybe_resize</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token operator">-&gt;</span>fd <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token comment">// 事件没有变化则直接返回 </span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>events <span class="token operator">==</span> w<span class="token operator">-&gt;</span>pevents<span class="token punctuation">)</span>  </span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token comment">// IO 观察者如果还没插入队列则插入 IO 观察者队列，等待 Poll IO 阶段的处理  </span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span>
<span class="line">        <span class="token function">QUEUE_INSERT_TAIL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token comment">// 保存映射关系，事件触发时通过 fd 获取对应的 IO 观察者，见 Poll IO 阶段的处理逻辑</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>w<span class="token operator">-&gt;</span>fd<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">        loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>w<span class="token operator">-&gt;</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> w<span class="token punctuation">;</span>  </span>
<span class="line">        loop<span class="token operator">-&gt;</span>nfds<span class="token operator">++</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token punctuation">}</span>  </span>
<span class="line"><span class="token punctuation">}</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__io_start 函数的逻辑主要如下:</p><ol><li>保存当前感兴趣的事情，但是还没有同步到操作系统。</li><li>把一个 IO 观察者插入到事件循环的观察者队列中，然后 Libuv 在 Poll IO 阶段会处理这个队列的数据，比如注册到操作系统中。</li><li>在 watchers 数组中保存一个映射关系，当从事件驱动模块返回时，Libuv 会根据拿到的 fd 从 watchers 中找到对应的 IO 观察者，从而执行回调，具体逻辑可参考下面的内容。</li></ol><p>注销事件</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__io_stop</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 清除不感兴趣的事件</span></span>
<span class="line">  w<span class="token operator">-&gt;</span>pevents <span class="token operator">&amp;=</span> <span class="token operator">~</span>events<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">/* </span>
<span class="line">      如果对任何事件都不感兴趣了，则把 loop-&gt;watchers[w-&gt;fd] 置 NULL，Poll IO 阶段会用到。</span>
<span class="line">      如果还有感兴趣的事件</span>
<span class="line">          并且还没有在 IO 观察者队列，则插入，等待 Poll IO阶段修改操作系统数据。</span>
<span class="line">          已经插入 IO 观察者队列了，则等待 Poll IO 阶段修改操作系统数据即可</span>
<span class="line">  */</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>pevents <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 移出 IO 观察者队列</span></span>
<span class="line">    <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">QUEUE_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    w<span class="token operator">-&gt;</span>events <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 置空，但是不会修改操作系统的数据，所以之前感兴趣的事件还是可能触发，</span></span>
<span class="line">    <span class="token comment">// Poll IO 阶段 需要通过 loop-&gt;watchers[w-&gt;fd] 为 NULL 进行过滤</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>w<span class="token operator">-&gt;</span>fd<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>w<span class="token operator">-&gt;</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></span>
<span class="line">      loop<span class="token operator">-&gt;</span>nfds<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">QUEUE_INSERT_TAIL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__io_stop 用于修改 IO 观察者感兴趣的事件，主要逻辑如下。</p><p>修改当前感兴趣的事件，但是还没有同步到操作系统。 如果还有感兴趣的事件并且 IO 观察者还没有插入 IO 观察者队列，则插入队列，否则不需要操作，因为修改的事件会在 Poll IO 阶段同步到操作系统，只需要保证 IO 观察者在队列里就行。 如果当前没有感兴趣的事件，则需要移出 IO 观察者队列，并删除 fd 到 IO 观察者的映射关系，但是不会实时地从事件驱动模块中注销这个 fd 的事件，因为 uv__io_stop 的语义是注销事件，后续还可以通过 uv__io_start 重新注册事件，所以实现上选择了先不注销事件驱动模块中的 fd 事件，减少一次系统调用，如果后续没有调用 uv__io_start，而又有事件触发时，Libuv 才会真正注销事件驱动中该 fd 对应的事件。 另外需要注意的是，当调用 uv__io_stop 注销事件时，注销的事件可能已经触发，比如在回调 1 里注销了回调 2 的事件，所以在 Poll IO 阶段时需要根据 pevents 进行判断，过滤已经被注销的事件，也就是说不需要执行相应的回调了。</p><p>关闭 IO 观察者</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__io_close</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 注销事件</span></span>
<span class="line">  <span class="token function">uv__io_stop</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token punctuation">,</span> POLLIN <span class="token operator">|</span> POLLOUT <span class="token operator">|</span> UV__POLLRDHUP <span class="token operator">|</span> UV__POLLPRI<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 移出 pending 队列，如果在的话</span></span>
<span class="line">  <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>w<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 从操作系</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token function">uv__platform_invalidate_fd</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token operator">-&gt;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__io_close 首先调用了 uv__io_stop 注销所有事件，然后调用 uv__platform_invalidate_fd。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">void</span> <span class="token function">uv__platform_invalidate_fd</span><span class="token punctuation">(</span><span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token operator">*</span> events<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> dummy<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span> i<span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">uintptr_t</span> nfds<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// events 和 nfds 为本轮 Poll IO 阶段返回的，代表触发的事件和个数</span></span>
<span class="line">    events <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token operator">*</span><span class="token punctuation">)</span> loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>loop<span class="token operator">-&gt;</span>nwatchers<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    nfds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uintptr_t</span><span class="token punctuation">)</span> loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>loop<span class="token operator">-&gt;</span>nwatchers <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 修改对应的结构体的 fd 为 -1</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nfds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">==</span> fd<span class="token punctuation">)</span></span>
<span class="line">        events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dummy<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 从事件驱动模块注销 fd</span></span>
<span class="line">    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>backend_fd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dummy<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__platform_invalidate_fd 会修改 Poll IO 阶段返回的事件结构体的 fd 为 -1。接着从事件驱动模块注销这个 fd 感兴趣的所有事件，这两步都是必要的，因为删除操作系统中感兴趣的事件只能保证后面不会触发，但是这个事件可能已经在本轮 Poll IO 阶段中触发，并等待处理，比如回调 1 里关闭了回调 2 的 IO 观察者，所以 Poll IO 阶段需要根据 fd 是否为 -1 进行过滤。</p><p>和 uv__io_stop 不一样的是，uv__io_close 会实时注销事件驱动模块中该 fd 对应的事件，因为 uv__io_close 的语义是这个 IO 观察者不会再被使用了，并且通常调用 uv__io_close 后 Libuv 会马上关闭 fd，如果这时候不实时地调用事件驱动模块注销该 fd 的事件，那就没有机会注销了。我们可以看看操作系统的代码：</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">do_epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>epds<span class="token punctuation">,</span> bool nonblock<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> error<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">fd</span> f<span class="token punctuation">;</span></span>
<span class="line">    error <span class="token operator">=</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 通过 fd 获取对应的结构体，已经关闭的 fd 则不会有对应的结构体</span></span>
<span class="line">    tf <span class="token operator">=</span> <span class="token function">fdget</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tf<span class="token punctuation">.</span>file<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">goto</span> error_fput<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，当我们调用事件驱动模块注销一个 fd 的事件时，如果这个 fd 已经被关闭，则会报错，所以 uv__io_close 需要在 fd 关闭之前注销 fd 的事件。</p><p>了解了 IO 观察者后，下面我们开始分析 Poll IO 阶段，Poll IO 具体处理逻辑在 uv__io_poll 这个函数。这个函数比较复杂，我们分开分析。</p><p>处理 IO 观察者注册事件 应用订阅的事件会首先保存到 IO 观察者中，然后在 Poll IO 阶段被处理，而不是在订阅时就实时处理，尽可能避免过多系统调用。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 遍历 IO 观察者队列</span></span>
<span class="line"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 取出当前头节点</span></span>
<span class="line">    q <span class="token operator">=</span> <span class="token function">QUEUE_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 移出队列</span></span>
<span class="line">    <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 重置节点的前后指针</span></span>
<span class="line">    <span class="token function">QUEUE_INIT</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 通过结构体成功获取结构体首地址</span></span>
<span class="line">    w <span class="token operator">=</span> <span class="token function">QUEUE_DATA</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token punctuation">,</span> watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 设置当前感兴趣的事件</span></span>
<span class="line">    e<span class="token punctuation">.</span>events <span class="token operator">=</span> w<span class="token operator">-&gt;</span>pevents<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 记录 fd，事件触发后再通过 fd 从 loop-&gt;watchs 字段里找到对应的 IO 观察者</span></span>
<span class="line">    e<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> w<span class="token operator">-&gt;</span>fd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// w-&gt;events 为 0 ，则新增，否则修改</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>events <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        op <span class="token operator">=</span> EPOLL_CTL_ADD<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        op <span class="token operator">=</span> EPOLL_CTL_MOD<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 修改 epoll 的数据</span></span>
<span class="line">    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>backend_fd<span class="token punctuation">,</span> op<span class="token punctuation">,</span> w<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 记录当前最新的状态</span></span>
<span class="line">    w<span class="token operator">-&gt;</span>events <span class="token operator">=</span> w<span class="token operator">-&gt;</span>pevents<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一步首先遍历 IO 观察者，修改 epoll 的数据，即注册 fd 感兴趣的事件，epoll 需要针对每个 IO 观察者调用一次系统调用 epoll_ctl，相比来说 kqueue 支持批量操作。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line">  <span class="token keyword">struct</span> <span class="token class-name">kevent</span> events<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">struct</span> <span class="token class-name">kevent</span><span class="token operator">*</span> ev<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">struct</span> <span class="token class-name">timespec</span> spec<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> nevents<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> revents<span class="token punctuation">;</span></span>
<span class="line">  QUEUE<span class="token operator">*</span> q<span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">uv__io_t</span><span class="token operator">*</span> w<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  nevents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    q <span class="token operator">=</span> <span class="token function">QUEUE_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">QUEUE_REMOVE</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">QUEUE_INIT</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    w <span class="token operator">=</span> <span class="token function">QUEUE_DATA</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token class-name">uv__io_t</span><span class="token punctuation">,</span> watcher_queue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 之前没有设置 POLLIN，但现在设置 POLLIN，则通知操作系统</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>events <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>pevents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      filter <span class="token operator">=</span> EVFILT_READ<span class="token punctuation">;</span></span>
<span class="line">      fflags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">      op <span class="token operator">=</span> EV_ADD<span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 把字段的值设置到第 n 个 kevent 结构体</span></span>
<span class="line">      <span class="token function">EV_SET</span><span class="token punctuation">(</span>events <span class="token operator">+</span> nevents<span class="token punctuation">,</span> w<span class="token operator">-&gt;</span>fd<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> op<span class="token punctuation">,</span> fflags<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">// 如果还没到 1024 个则继续操作，到 1024 个后调用系统调用函数 kevent 进行批量操作</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>nevents <span class="token operator">==</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">kevent</span><span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>backend_fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> nevents<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 重置索引</span></span>
<span class="line">        nevents <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 省略部分代码</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 kqueue 可以累积多个 IO 观察者的事件进行批量设置，这样可以减少系统调用的次数，一定程度提高性能。接着看处理完 IO 观察者后的逻辑。</p><p>等待事件触发或超时</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">// 阻塞等待事件或超时，events 保存就绪的事件，nfds 保存就绪的事件个数</span></span>
<span class="line"><span class="token keyword">int</span> nfds <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>backend_fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">,</span>  timeout<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>epoll_wait 用于阻塞等待事件的触发，这就是前面提到的阻塞 / 唤醒机制的实现。epoll_wait 除了在事件触发时返回，还支持超时的概念，也就是如果超过一定的时间还没有事件触发，则返回。阻塞时间的计算规则如下：</p><p>0 代表不阻塞；</p><blockquote><p>0 代表最多阻塞一段时间； &lt; 0 代表一直阻塞，直到有事件发生。 Libuv 中，这个超时时间由 uv_backend_timeout 实现。</p></blockquote><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv_backend_timeout</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 下面几种情况下返回 0 ，即不阻塞在epoll_wait</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>stop_flag <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 没有事件需要处理，则不需要阻塞 poll io 阶段</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">uv__has_active_handles</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">uv__has_active_reqs</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// idle 阶段有任务，不阻塞，尽快返回处理 idle 任务</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>idle_handles<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 同上</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">QUEUE_EMPTY</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loop<span class="token operator">-&gt;</span>pending_queue<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 同上</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>closing_handles<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 返回下一个最早过期的时间，即最早超时的节点</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">uv__next_timeout</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从 uv_backend_timeout 中可以知道，Libuv 的各个阶段中，只有 prepare 和 check 阶段的任务不会影响 Poll IO 阶段的超时时间的计算。回到 uv_backend_timeout，除了返回 0 的情况外，剩下的就是计算最快超时的节点的时间，以此作为事件循环阻塞的最长时间，因为 Libuv 需要保证定时器按时执行。下面看看定时器的计算逻辑。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">int</span> <span class="token function">uv__next_timeout</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uv_loop_t</span><span class="token operator">*</span> loop<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">heap_node</span><span class="token operator">*</span> heap_node<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token class-name">uv_timer_t</span><span class="token operator">*</span> handle<span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">uint64_t</span> diff<span class="token punctuation">;</span></span>
<span class="line">  heap_node <span class="token operator">=</span> <span class="token function">heap_min</span><span class="token punctuation">(</span><span class="token function">timer_heap</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 没有定时器则事件循环一直阻塞</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>heap_node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">  handle <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>heap_node<span class="token punctuation">,</span> <span class="token class-name">uv_timer_t</span><span class="token punctuation">,</span> heap_node<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 已经超时的节点会被 timer 阶段执行，这里不太可能出现</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token operator">-&gt;</span>timeout <span class="token operator">&lt;=</span> loop<span class="token operator">-&gt;</span>time<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 计算最快超时的节点还需要多久超时，以此作为事件循环的最长阻塞时间</span></span>
<span class="line">  diff <span class="token operator">=</span> handle<span class="token operator">-&gt;</span>timeout <span class="token operator">-</span> loop<span class="token operator">-&gt;</span>time<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">&gt;</span> INT_MAX<span class="token punctuation">)</span></span>
<span class="line">    diff <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> diff<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>uv__next_timeout 判断是否有定时器，有则返回最快到期节点的时间</p><p>处理触发的事件</p><p>从上面的分析中可知， epoll_wait 返回时，可能是超时，也可能是有事件触发，具体需要根据 epoll_wait 的返回值判断，epoll_wait 返回值表示有多少个 fd 的事件触发了。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token comment">/*</span>
<span class="line">    epoll_wait 可能会引起主线程阻塞，具体要根据 Libuv 当前的情况。所以</span>
<span class="line">    wait 返回后需要更新当前的时间，否则在使用的时候时间差会比较大。因为</span>
<span class="line">    Libuv 会在每轮时间循环开始的时候缓存当前时间这个值。其他地方直接使用，</span>
<span class="line">    而不是每次都去获取。</span>
<span class="line">*/</span></span>
<span class="line"><span class="token function">uv__update_time</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 遍历有事件触发的 fd</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nfds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 哪个 fd 触发了什么事情</span></span>
<span class="line">    pe <span class="token operator">=</span> events <span class="token operator">+</span> i<span class="token punctuation">;</span></span>
<span class="line">    fd <span class="token operator">=</span> pe<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 根据 fd 获取 IO 观察者</span></span>
<span class="line">    w <span class="token operator">=</span> loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 执行回调</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pe<span class="token operator">-&gt;</span>events <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        w<span class="token operator">-&gt;</span><span class="token function">cb</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token punctuation">,</span> pe<span class="token operator">-&gt;</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 epoll_wait 返回的事件和个数，从根据事件结构体找到关联的 IO 观察者，然后执行对应回调即可。</p><p>删除事件的处理</p><p>刚才介绍的是事件注册到事件触发和处理的过程，还有一个重要的事情需要处理，那就是过滤掉已经注销的事件。这个事情的重点在于，如果之前订阅的事件触发了，但目前又不感兴趣了，应该如何处理这种过期的事件，这个过期事件可能来源于 Libuv 还没有同步最新的数据到操作系统，也可能来源于前面的回调删除了后面回调的事件或 IO 观察者，比如在回调 1 里注销了回调 2 的事件，那么就不需要执行回调 2 了。接下来看如何实现对这些情况的判断。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nfds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    pe <span class="token operator">=</span> events <span class="token operator">+</span> i<span class="token punctuation">;</span></span>
<span class="line">    fd <span class="token operator">=</span> pe<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// fd 无效则不需要处理了（调用了 uv__io_close）</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// IO 观察者已经被删除则不需要执行回调了（调用了 uv__io_stop），并且删除操作系统的数据</span></span>
<span class="line">    w <span class="token operator">=</span> loop<span class="token operator">-&gt;</span>watchers<span class="token punctuation">[</span>fd<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>loop<span class="token operator">-&gt;</span>backend_fd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> pe<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">continue</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 和当前感兴趣的事件 w-&gt;pevents 进行 &amp; 操作，保证剩下的事件 pe-&gt;events 已经触发且感兴趣的</span></span>
<span class="line">    pe<span class="token operator">-&gt;</span>events <span class="token operator">&amp;=</span> w<span class="token operator">-&gt;</span>pevents <span class="token operator">|</span> POLLERR <span class="token operator">|</span> POLLHUP<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pe<span class="token operator">-&gt;</span>events <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        w<span class="token operator">-&gt;</span><span class="token function">cb</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> w<span class="token punctuation">,</span> pe<span class="token operator">-&gt;</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面代码中可以看到，Libuv 会根据 uv__io_stop 和 uv__io_close 设置的各种标记进行过滤，避免处理过期的事件。下面是 Poll IO 阶段的整体流程图。</p><p>总结：</p><p>事件循环是一个非常通用的技术，简单来说就是在一个循环中不断地处理生产者产生的任务。这节课我们介绍了事件循环的概念，然后按照简单到复杂的顺序，梳理了事件循环各个执行阶段的具体实现，可以清晰地了解到 Node.js 中哪些任务是在哪个阶段被执行的。</p><p>其中，Poll IO 阶段是最重要也是最复杂的一个阶段， Node.js 的网络 IO、线程池完成任务、信号处理等回调都是在这个阶段处理的。因此，我们要重点学习它，具体有以下几点。</p><p>事件驱动是操作系统提供的一种订阅 / 发布机制，由 IO 多路复用模块实现，且不同操作系统中提供的系统调用不一样，我们需要了解它的工作原理和使用方式。 IO 观察者是 Poll IO 阶段最重要的数据结构，它本质上是封装了 fd、感兴趣的事件和回调函数。结合事件驱动模块，就可以实现对 fd 的处理，例如网络数据的读写。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wupan1030@foxmail.com">sindorei</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/note/nodejs/deep_into_nodejs/libuv/data_struct.html" aria-label="libuv数据结构与通用逻辑"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>libuv数据结构与通用逻辑</span></div></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/note/assets/app-LHpjaFTr.js" defer></script>
  </body>
</html>
