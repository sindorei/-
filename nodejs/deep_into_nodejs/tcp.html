<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>Node.js TCP 数据通信的实现 | 笔记</title><meta name="description" content="学习及练习的记录">
    <link rel="preload" href="/note/assets/style-BYxJ5vVe.css" as="style"><link rel="stylesheet" href="/note/assets/style-BYxJ5vVe.css">
    <link rel="modulepreload" href="/note/assets/app-LHpjaFTr.js"><link rel="modulepreload" href="/note/assets/tcp.html-Tzei2pG2.js">
    <link rel="prefetch" href="/note/assets/index.html-CRKJAktu.js" as="script"><link rel="prefetch" href="/note/assets/编程语言的设计与实现.html-DMqrpBQ5.js" as="script"><link rel="prefetch" href="/note/assets/game.html-BpAPjRzA.js" as="script"><link rel="prefetch" href="/note/assets/go.html-DVSc15Kw.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BoNoRfZV.js" as="script"><link rel="prefetch" href="/note/assets/object.html-CpQ6YJU-.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BzmysG6T.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CdhVk01G.js" as="script"><link rel="prefetch" href="/note/assets/base_command.html-CHIvgGjv.js" as="script"><link rel="prefetch" href="/note/assets/docker_file.html-B5BYohMD.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CTdpb_rx.js" as="script"><link rel="prefetch" href="/note/assets/nodejs_image.html-DZicQK8S.js" as="script"><link rel="prefetch" href="/note/assets/git.html-CwBwNumC.js" as="script"><link rel="prefetch" href="/note/assets/http.html-CO9DwlcH.js" as="script"><link rel="prefetch" href="/note/assets/01.html-D08vSd6w.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CNuxsu-u.js" as="script"><link rel="prefetch" href="/note/assets/flex.html-DeYvkDAP.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DAiJKrDV.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CC79gBXK.js" as="script"><link rel="prefetch" href="/note/assets/ssr.html-CzWTTslj.js" as="script"><link rel="prefetch" href="/note/assets/vue3.html-BkjS9Z6u.js" as="script"><link rel="prefetch" href="/note/assets/01.html-BGyc60LY.js" as="script"><link rel="prefetch" href="/note/assets/02.html-D403JbXn.js" as="script"><link rel="prefetch" href="/note/assets/03.html-CGD6-qXW.js" as="script"><link rel="prefetch" href="/note/assets/04.html-PTAWabi_.js" as="script"><link rel="prefetch" href="/note/assets/05.html-CWFDSO4R.js" as="script"><link rel="prefetch" href="/note/assets/06.html-Ge6hEPSP.js" as="script"><link rel="prefetch" href="/note/assets/07.html-DG337sUc.js" as="script"><link rel="prefetch" href="/note/assets/08.html-CXQlh6qu.js" as="script"><link rel="prefetch" href="/note/assets/09.html-DobF94Gq.js" as="script"><link rel="prefetch" href="/note/assets/10.html-V02h8t29.js" as="script"><link rel="prefetch" href="/note/assets/11.html-Cxoqw4eS.js" as="script"><link rel="prefetch" href="/note/assets/12.html-YwJ00UTC.js" as="script"><link rel="prefetch" href="/note/assets/13.html-C4l31hYp.js" as="script"><link rel="prefetch" href="/note/assets/14.html-DBw4HV5O.js" as="script"><link rel="prefetch" href="/note/assets/15.html-DFEadcEY.js" as="script"><link rel="prefetch" href="/note/assets/16.html-BiiDI-MZ.js" as="script"><link rel="prefetch" href="/note/assets/17.html-CjzgDSV0.js" as="script"><link rel="prefetch" href="/note/assets/23.html-p-unLygU.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DGGZ1YGN.js" as="script"><link rel="prefetch" href="/note/assets/index.html-l-1l6LtJ.js" as="script"><link rel="prefetch" href="/note/assets/ap.html-CnmIQwyq.js" as="script"><link rel="prefetch" href="/note/assets/basic_sentence.html-CHMQ4J1P.js" as="script"><link rel="prefetch" href="/note/assets/clause.html-DDuuROBl.js" as="script"><link rel="prefetch" href="/note/assets/difference.html-CsOpK_XV.js" as="script"><link rel="prefetch" href="/note/assets/english_grammar_system.html-C8Go9I1E.js" as="script"><link rel="prefetch" href="/note/assets/noun.html-C9hRA14e.js" as="script"><link rel="prefetch" href="/note/assets/noun_phrase.html-DWz5xJO7.js" as="script"><link rel="prefetch" href="/note/assets/other.html-Bxlzxm-F.js" as="script"><link rel="prefetch" href="/note/assets/part_of_speech.html-BdGvDch7.js" as="script"><link rel="prefetch" href="/note/assets/phonetic_symbol.html-COKk3LiF.js" as="script"><link rel="prefetch" href="/note/assets/pronunciation_respelling.html-CASSzY-d.js" as="script"><link rel="prefetch" href="/note/assets/spoken_english.html-9A11oUFP.js" as="script"><link rel="prefetch" href="/note/assets/tense.html-Bp6DLOFz.js" as="script"><link rel="prefetch" href="/note/assets/vedios.html-CZFUZ8uU.js" as="script"><link rel="prefetch" href="/note/assets/word.html-sCscP_by.js" as="script"><link rel="prefetch" href="/note/assets/yinxingyi.html-Dz9DHIDO.js" as="script"><link rel="prefetch" href="/note/assets/zhangdaozhen.html-qGrFL9y7.js" as="script"><link rel="prefetch" href="/note/assets/bootstrap.html-B7goD2y1.js" as="script"><link rel="prefetch" href="/note/assets/dns.html-BtlwnnRk.js" as="script"><link rel="prefetch" href="/note/assets/file.html-DdTHP9HO.js" as="script"><link rel="prefetch" href="/note/assets/file_watch.html-CAVAmcLY.js" as="script"><link rel="prefetch" href="/note/assets/http.html-BrsbBXzu.js" as="script"><link rel="prefetch" href="/note/assets/index.html-ma5b5YJ4.js" as="script"><link rel="prefetch" href="/note/assets/memory.html-BBJmuRQo.js" as="script"><link rel="prefetch" href="/note/assets/module.html-DDdLXPNq.js" as="script"><link rel="prefetch" href="/note/assets/process.html-WBKE4Y4I.js" as="script"><link rel="prefetch" href="/note/assets/runtime.html-BLnJGDB_.js" as="script"><link rel="prefetch" href="/note/assets/setImmediate.html-DCBPJllt.js" as="script"><link rel="prefetch" href="/note/assets/tcp_server_client.html-PlTwphfT.js" as="script"><link rel="prefetch" href="/note/assets/thread.html-pxQtUnzX.js" as="script"><link rel="prefetch" href="/note/assets/udp.html-CG1Hylul.js" as="script"><link rel="prefetch" href="/note/assets/unix_fd.html-CGjgL0dh.js" as="script"><link rel="prefetch" href="/note/assets/curl.html-CiO5vNwi.js" as="script"><link rel="prefetch" href="/note/assets/index.html-D8kuWLtK.js" as="script"><link rel="prefetch" href="/note/assets/singleton.html-BZZtufAV.js" as="script"><link rel="prefetch" href="/note/assets/command.html-Dub5Hj_m.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DSKs7BF_.js" as="script"><link rel="prefetch" href="/note/assets/index.html-C-sKCQde.js" as="script"><link rel="prefetch" href="/note/assets/11-20.html-DpEQDb6H.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CW1ro9zz.js" as="script"><link rel="prefetch" href="/note/assets/control.html-DbrYfu72.js" as="script"><link rel="prefetch" href="/note/assets/coroutine.html-CXgFu5Kg.js" as="script"><link rel="prefetch" href="/note/assets/error_except.html-XpaplLQ7.js" as="script"><link rel="prefetch" href="/note/assets/function.html-BYaXKKOL.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BQYErj4Q.js" as="script"><link rel="prefetch" href="/note/assets/module.html-DuJWV5-u.js" as="script"><link rel="prefetch" href="/note/assets/operator.html-Bl8Ll6sn.js" as="script"><link rel="prefetch" href="/note/assets/types.html-Eo9QZ4HV.js" as="script"><link rel="prefetch" href="/note/assets/class.html-91Gr4n-o.js" as="script"><link rel="prefetch" href="/note/assets/control_flow.html-BDFi5U9A.js" as="script"><link rel="prefetch" href="/note/assets/error_except.html-BJHPkAqX.js" as="script"><link rel="prefetch" href="/note/assets/function.html-sbFdXM7Z.js" as="script"><link rel="prefetch" href="/note/assets/index.html-C9i3pZ5V.js" as="script"><link rel="prefetch" href="/note/assets/module.html-CeUICiZp.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DSw-RJA-.js" as="script"><link rel="prefetch" href="/note/assets/start.html-DdNFeOvS.js" as="script"><link rel="prefetch" href="/note/assets/trpl.html-BtmJ3sJj.js" as="script"><link rel="prefetch" href="/note/assets/closure.html-CoNM3Qld.js" as="script"><link rel="prefetch" href="/note/assets/control_flow.html-5oKkjaOS.js" as="script"><link rel="prefetch" href="/note/assets/function.html-BAz4Sybn.js" as="script"><link rel="prefetch" href="/note/assets/index.html-D9utc7LP.js" as="script"><link rel="prefetch" href="/note/assets/operator.html-BIfws0KF.js" as="script"><link rel="prefetch" href="/note/assets/types.html-DZ1oI1e1.js" as="script"><link rel="prefetch" href="/note/assets/index.html-Bmceai8b.js" as="script"><link rel="prefetch" href="/note/assets/introduction.html-BEwqBwa_.js" as="script"><link rel="prefetch" href="/note/assets/bem.html-BscxAu2c.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DuSoPzyE.js" as="script"><link rel="prefetch" href="/note/assets/index.html-Dh6Ek41Y.js" as="script"><link rel="prefetch" href="/note/assets/code_spliting.html-Dj5pKKWS.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DcdBaI7M.js" as="script"><link rel="prefetch" href="/note/assets/tapable.html-DvpxAFCy.js" as="script"><link rel="prefetch" href="/note/assets/upgrade.html-CaJRu46c.js" as="script"><link rel="prefetch" href="/note/assets/index.html-B9menBKR.js" as="script"><link rel="prefetch" href="/note/assets/1.html-BTh8slHL.js" as="script"><link rel="prefetch" href="/note/assets/2.html-ItJLJwEM.js" as="script"><link rel="prefetch" href="/note/assets/3.html-7uCZe3p0.js" as="script"><link rel="prefetch" href="/note/assets/4.html-bq3pIVs0.js" as="script"><link rel="prefetch" href="/note/assets/index.html-ZMjTc9x_.js" as="script"><link rel="prefetch" href="/note/assets/data_struct.html-BuYtyN7t.js" as="script"><link rel="prefetch" href="/note/assets/eventloop.html-_2UGpvb8.js" as="script"><link rel="prefetch" href="/note/assets/libuv_js.html-CAO1XwO_.js" as="script"><link rel="prefetch" href="/note/assets/stream.html-CRD2yEUX.js" as="script"><link rel="prefetch" href="/note/assets/thread.html-CtgZ_SME.js" as="script"><link rel="prefetch" href="/note/assets/index.html-kRfWoiyf.js" as="script"><link rel="prefetch" href="/note/assets/qml_syntax.html-J-OJ77lS.js" as="script"><link rel="prefetch" href="/note/assets/404.html-DNCO1rp7.js" as="script"><link rel="prefetch" href="/note/assets/setupDevtools-7MC2TMWH-C61GSS5L.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/note/"><!----><span class="vp-site-name" aria-hidden="true">笔记</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><!----><!--[--><!--]--><!----><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">深入剖析 Node.js 底层原理 <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><p tabindex="0" class="vp-sidebar-item">libuv <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/nodejs/deep_into_nodejs/libuv/data_struct.html" aria-label="libuv数据结构与通用逻辑"><!---->libuv数据结构与通用逻辑<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/nodejs/deep_into_nodejs/libuv/eventloop.html" aria-label="libuv 事件循环"><!---->libuv 事件循环<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="node-js-tcp-数据通信的实现" tabindex="-1"><a class="header-anchor" href="#node-js-tcp-数据通信的实现"><span>Node.js TCP 数据通信的实现</span></a></h1><p>建立了 TCP 连接后，我们就可以在这个连接上进行数据通信，下面我们来详细讲解数据通信的内容。</p><p>读操作 上节课讲过，建立 TCP 连接后，Node.js 会创建一个 socket 对象来表示通信的一端。那么，socket 的读操作逻辑是怎样的呢？连接成功后，socket 会通过 read 函数在底层注册等待可读事件。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">afterConnect</span><span class="token punctuation">(</span><span class="token parameter">status<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> req<span class="token punctuation">,</span> readable<span class="token punctuation">,</span> writable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// self 是 JS 层的 Socket 对象</span></span>
<span class="line">  <span class="token keyword">const</span> self <span class="token operator">=</span> handle<span class="token punctuation">[</span>owner_symbol<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 则注册可读事件</span></span>
<span class="line">  self<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为 Socket 继承了 Readable，所以调用 read 时执行的是 Readable 的 read 函数。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Readable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">read</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_read</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>_read 函数是由 Socket 实现。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Socket</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_read</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">tryReadStart</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">tryReadStart</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  socket<span class="token punctuation">.</span>_handle<span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  socket<span class="token punctuation">.</span>_handle<span class="token punctuation">.</span><span class="token function">readStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终调用了 _handle 的 readStart（_handle 是 new TCP 返回的对象，关联了 C++ 层的 TCPWrap 对象），该函数在 TCPWrap 的父类中定义，对应为 StreamBase::ReadStartJS 函数。关键代码在 tcp_wrap.cc 的下面这一句。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">// t 为 JS 层使用的 TCP 函数模版，即上面的 _handle</span>
<span class="line">t-&gt;Inherit(LibuvStreamWrap::GetConstructorTemplate(env));</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>接着看一下 LibuvStreamWrap::GetConstructorTemplate。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">Local&lt;FunctionTemplate&gt; LibuvStreamWrap::GetConstructorTemplate(</span>
<span class="line">    Environment* env) {</span>
<span class="line">  Local&lt;FunctionTemplate&gt; tmpl = env-&gt;libuv_stream_wrap_ctor_template();</span>
<span class="line">  if (tmpl.IsEmpty()) {</span>
<span class="line">    // 新的函数模版 LibuvStreamWrap</span>
<span class="line">    tmpl = env-&gt;NewFunctionTemplate(nullptr);</span>
<span class="line">    tmpl-&gt;SetClassName(FIXED_ONE_BYTE_STRING(env-&gt;isolate(), &quot;LibuvStreamWrap&quot;));</span>
<span class="line">    // 忽略一些不相关代码</span>
<span class="line">    // 新增一些 StreamBase 中的方法</span>
<span class="line">    StreamBase::AddMethods(env, tmpl);</span>
<span class="line">    env-&gt;set_libuv_stream_wrap_ctor_template(tmpl);</span>
<span class="line">  }</span>
<span class="line">  return tmpl;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>继续看 StreamBase::AddMethods 的关键代码。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">env-&gt;SetProtoMethod(t, &quot;readStart&quot;, JSMethod&lt;&amp;StreamBase::ReadStartJS&gt;);</span>
<span class="line">env-&gt;SetProtoMethod(t, &quot;readStop&quot;, JSMethod&lt;&amp;StreamBase::ReadStopJS&gt;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>因为 C++ 层导出的 TCP 函数继承了 LibuvStreamWrap， LibuvStreamWrap 中通过 StreamBase::AddMethods 定义了 readStart，所以可以在 _handle 中直接使用 readStart，接下来继续分析 readStart。readStart 对应函数是 JSMethod，这是个模版函数。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">template &lt;int (StreamBase::*Method)(const FunctionCallbackInfo&lt;Value&gt;&amp; args)&gt;</span>
<span class="line">void StreamBase::JSMethod(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span>
<span class="line">  // 拿到 JS 对象关联的 TCPWrap 对象</span>
<span class="line">  StreamBase* wrap = StreamBase::FromObject(args.Holder().As&lt;Object&gt;());</span>
<span class="line">  args.GetReturnValue().Set((wrap-&gt;*Method)(args));</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JSMethod 首先根据 JS 对象拿到 C++ 对象，然后执行它的 ReadStartJS 函数。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">int StreamBase::ReadStartJS(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span>
<span class="line">  return ReadStart();</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ReadStart 由 LibuvStreamWrap（LibuvStreamWrap 是 StreamBase 子类，TCPWrap 的父类） 定义，具体在 stream_wrap.cc。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">// 注册读事件  </span>
<span class="line">int LibuvStreamWrap::ReadStart() {</span>
<span class="line">  return uv_read_start(</span>
<span class="line">   stream(),</span>
<span class="line">   [](uv_handle_t* handle, size_t suggested_size, uv_buf_t* buf) {</span>
<span class="line">     // 分配存储数据的内存</span>
<span class="line">     static_cast&lt;LibuvStreamWrap*&gt;(handle-&gt;data)-&gt;OnUvAlloc(suggested_size, buf);</span>
<span class="line">   },</span>
<span class="line">   [](uv_stream_t* stream, ssize_t nread, const uv_buf_t* buf) {</span>
<span class="line">     LibuvStreamWrap* wrap = static_cast&lt;LibuvStreamWrap*&gt;(stream-&gt;data);</span>
<span class="line">     // 读取数据的回调  </span>
<span class="line">     wrap-&gt;OnUvRead(nread, buf);</span>
<span class="line">   });</span>
<span class="line">} </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ReadStart 中调用 uv_read_start 往 Libuv 注册了等待可读事件，然后在有数据可读时执行 OnUvRead 函数，最终执行 JS 层的 onread 回调，对应函数为 onStreamRead。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">onStreamRead</span><span class="token punctuation">(</span><span class="token parameter">arrayBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> nread <span class="token operator">=</span> streamBaseState<span class="token punctuation">[</span>kReadBytesOrError<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 获取关联的流，这里是 socket 对象</span></span>
<span class="line">  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>owner_symbol<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 有数据</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>stream<span class="token punctuation">.</span>destroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> ret<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 把数据 push 到可读流中，一般是触发 data 事件</span></span>
<span class="line">    <span class="token keyword">let</span> result <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 返回 false 说明累积的数据达到阈值，停止读操作</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      handle<span class="token punctuation">.</span>reading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">      handle<span class="token punctuation">.</span><span class="token function">readStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> ret<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// 不等于流结束的错误码，说明读出错了，关闭连接</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>nread <span class="token operator">!==</span> <span class="token constant">UV_EOF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    stream<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token function">errnoException</span><span class="token punctuation">(</span>nread<span class="token punctuation">,</span> <span class="token string">&#39;read&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// 没有数据可以读了，push null 表示可读流结束</span></span>
<span class="line">  stream<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token comment">/*</span>
<span class="line">    执行 read，如果流中没有缓存的数据则会触发 end 事件，</span>
<span class="line">    否则等待消费完后再触发  </span>
<span class="line">  */</span></span>
<span class="line">  stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>socket 可读事件触发时，大概有下面几种情况。</p><p>有数据则把数据追加到流中，并触发 data 事件通知用户。 没有有效数据可读，忽略。 读出错，销毁流，即关闭连接。 读结束。 前 3 种情况很好理解，这里我们重点分析下第 4 种情况。新建一个 socket 的时候注册了读结束的处理函数 onReadableStreamEnd。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">onReadableStreamEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 不允许半关闭</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowHalfOpen<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 修改 write 函数，用户再调用 write 的函数则报错 This socket has been ended by the other party</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>write <span class="token operator">=</span> writeAfterFIN<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 如果还可写，则发送 fin 给对端，说明不会再发送数据了</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>writable<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 如果没有待发送的数据并且不可写了则销毁流</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>destroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>writable <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>writableLength<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当 socket 的读端结束时，如果写端没有结束，则判断 allowHalfOpen 是否允许半关闭，不允许半开关则关闭写端（该逻辑在新版 Node.js 有所改动），如果后续再调用 write 则会报错 This socket has been ended by the other party。</p><p>写操作 接着来看 socket 写入数据的逻辑。Socket 继承 Writable 流，所以执行 write 时调用 Writable 的 write 函数。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Writable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">write</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_writableState<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 返回是否还能继续写，false 的话最好不要继续调用 write，否则内存挤压数据过多</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">writeOrBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">writeOrBuffer</span><span class="token punctuation">(</span><span class="token parameter">stream<span class="token punctuation">,</span> state<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">const</span> len <span class="token operator">=</span> state<span class="token punctuation">.</span>objectMode <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 等待写的数据长度</span></span>
<span class="line">  state<span class="token punctuation">.</span>length <span class="token operator">+=</span> len<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 是否超过了阈值</span></span>
<span class="line">  <span class="token keyword">const</span> ret <span class="token operator">=</span> state<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> state<span class="token punctuation">.</span>highWaterMark<span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">doWrite</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 返回是否还可以继续写</span></span>
<span class="line">  <span class="token keyword">return</span> ret<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">doWrite</span><span class="token punctuation">(</span><span class="token parameter">stream<span class="token punctuation">,</span> state<span class="token punctuation">,</span> writev<span class="token punctuation">,</span> len<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  stream<span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>write 是通用的逻辑，具体的写入逻辑由子类的 _write 实现，这里是 Socket。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token comment">// 单个写  </span></span>
<span class="line"><span class="token class-name">Socket</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_write</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_writeGeneric</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span>  </span>
<span class="line"></span>
<span class="line"><span class="token class-name">Socket</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_writeGeneric</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">writev<span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token function">writeGeneric</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span>  </span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">writeGeneric</span><span class="token punctuation">(</span><span class="token parameter">self<span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteWrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> handle <span class="token operator">=</span> self<span class="token punctuation">[</span>kHandle<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>handle <span class="token operator">=</span> handle<span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>oncomplete <span class="token operator">=</span> onWriteComplete<span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>bytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  handle<span class="token punctuation">.</span><span class="token function">writeUtf8String</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> req<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>writeGeneric 创建一个写请求对象，然后调用 writeUtf8String，writeUtf8String 对应 C++ 函数为 JSMethod&lt;&amp;StreamBase::WriteString&gt;。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">template &lt;enum encoding enc&gt;</span>
<span class="line">int StreamBase::WriteString(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span>
<span class="line">  Environment* env = Environment::GetCurrent(args);</span>
<span class="line">  </span>
<span class="line">  Local&lt;Object&gt; req_wrap_obj = args[0].As&lt;Object&gt;();</span>
<span class="line">  Local&lt;String&gt; string = args[1].As&lt;String&gt;();</span>
<span class="line">  // 计算要发送的数据的大小</span>
<span class="line">  size_t storage_size = // 忽略细节处理</span>
<span class="line">  </span>
<span class="line">  char stack_storage[16384];  // 16kb</span>
<span class="line">  size_t data_size;</span>
<span class="line">  size_t synchronously_written = 0;</span>
<span class="line">  uv_buf_t buf;</span>
<span class="line">  // 是否可以直接发送（小于 16kb 并且不需要发送文件描述符），还是等待可写事件</span>
<span class="line">  bool try_write = storage_size &lt;= sizeof(stack_storage) &amp;&amp; (!IsIPCPipe() || send_handle_obj.IsEmpty());</span>
<span class="line">  if (try_write) {</span>
<span class="line">    // 数据编码处理</span>
<span class="line">    data_size = StringBytes::Write(env-&gt;isolate(),</span>
<span class="line">                                   stack_storage,</span>
<span class="line">                                   storage_size,</span>
<span class="line">                                   string,</span>
<span class="line">                                   enc);</span>
<span class="line">    buf = uv_buf_init(stack_storage, data_size);</span>
<span class="line"></span>
<span class="line">    uv_buf_t* bufs = &amp;buf;</span>
<span class="line">    size_t count = 1;</span>
<span class="line">    // 尝试直接发送，count 保存了剩余的 buf 数</span>
<span class="line">    const int err = DoTryWrite(&amp;bufs, &amp;count);</span>
<span class="line">    // 失败或者发完了就直接返回</span>
<span class="line">    if (err != 0 || count == 0) {</span>
<span class="line">      SetWriteResult(StreamWriteResult { false, err, nullptr, data_size });</span>
<span class="line">      return err;</span>
<span class="line">    }</span>
<span class="line">  }</span>
<span class="line">  // 忽略细节处理</span>
<span class="line">  // 继续发剩下的</span>
<span class="line">  Write(&amp;buf, 1, send_handle, req_wrap_obj);</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>WriteString 首先计算发送数据的大小，如果满足条件则会先尝试直接进行发送，否则注册等待可写事件，等事件触发后再发送。我们只看 Write 函数。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">inline StreamWriteResult StreamBase::Write(</span>
<span class="line">    uv_buf_t* bufs,</span>
<span class="line">    size_t count,</span>
<span class="line">    uv_stream_t* send_handle,</span>
<span class="line">    v8::Local&lt;v8::Object&gt; req_wrap_obj) {</span>
<span class="line">  Environment* env = stream_env();</span>
<span class="line">  int err;</span>
<span class="line"></span>
<span class="line">  // 创建一个用于请求Libuv的写请求对象，和 ConnectWrap 类似</span>
<span class="line">  WriteWrap* req_wrap = CreateWriteWrap(req_wrap_obj);</span>
<span class="line">  // 执行写</span>
<span class="line">  DoWrite(req_wrap, bufs, count, send_handle);</span>
<span class="line"> </span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Write 是通用的逻辑，最终通过子类的 DoWrite 实现数据的发送。对于 TCP 模块来说是LibuvStreamWrap 中的 DoWrite 函数。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">int LibuvStreamWrap::DoWrite(WriteWrap* req_wrap,</span>
<span class="line">                             uv_buf_t* bufs,</span>
<span class="line">                             size_t count,</span>
<span class="line">                             uv_stream_t* send_handle) {</span>
<span class="line">  LibuvWriteWrap* w = static_cast&lt;LibuvWriteWrap*&gt;(req_wrap);</span>
<span class="line">  return w-&gt;Dispatch(uv_write2,</span>
<span class="line">                     stream(),</span>
<span class="line">                     bufs,</span>
<span class="line">                     count,</span>
<span class="line">                     send_handle,</span>
<span class="line">                     AfterUvWrite);</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终调用 Libuv 的 uv_write2 发送数据，就是我们前面课程介绍的 Libuv 流机制，Libuv 把数据写入操作系统后，就执行 C++ 的 AfterUvWrite 回调。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">void LibuvStreamWrap::AfterUvWrite(uv_write_t* req, int status) {</span>
<span class="line">  // 拿到写请求的 C++ 对象</span>
<span class="line">  LibuvWriteWrap* req_wrap = static_cast&lt;LibuvWriteWrap*&gt;(LibuvWriteWrap::from_req(req));</span>
<span class="line">  req_wrap-&gt;Done(status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">inline void StreamReq::Done(int status, const char* error_str) {</span>
<span class="line">  // 执行子类的OnDone</span>
<span class="line">  OnDone(status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">// 请求Libuv结束后的回调</span>
<span class="line">inline void WriteWrap::OnDone(int status) {</span>
<span class="line">  stream()-&gt;EmitAfterWrite(this, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">inline void StreamResource::EmitAfterWrite(WriteWrap* w, int status) {</span>
<span class="line">  listener_-&gt;OnStreamAfterWrite(w, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">// 实现写结束时的处理逻辑</span>
<span class="line">inline void StreamListener::OnStreamAfterWrite(WriteWrap* w, int status) {</span>
<span class="line">  previous_listener_-&gt;OnStreamAfterWrite(w, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void ReportWritesToJSStreamListener::OnStreamAfterWrite(</span>
<span class="line">    WriteWrap* req_wrap, int status) {</span>
<span class="line">  OnStreamAfterReqFinished(req_wrap, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void ReportWritesToJSStreamListener::OnStreamAfterReqFinished(</span>
<span class="line">    StreamReq* req_wrap, int status) {</span>
<span class="line">  // 请求所操作的流</span>
<span class="line">  StreamBase* stream = static_cast&lt;StreamBase*&gt;(stream_);</span>
<span class="line">  Environment* env = stream-&gt;stream_env();</span>
<span class="line">  AsyncWrap* async_wrap = req_wrap-&gt;GetAsyncWrap();</span>
<span class="line">  // 获取原始的 JS 层对象</span>
<span class="line">  Local&lt;Object&gt; req_wrap_obj = async_wrap-&gt;object();</span>
<span class="line"></span>
<span class="line">  Local&lt;Value&gt; argv[] = {</span>
<span class="line">    Integer::New(env-&gt;isolate(), status),</span>
<span class="line">    stream-&gt;GetObject(),</span>
<span class="line">    Undefined(env-&gt;isolate())</span>
<span class="line">  };</span>
<span class="line"></span>
<span class="line">  // 回调 JS 层</span>
<span class="line">  if (req_wrap_obj-&gt;Has(env-&gt;context(), env-&gt;oncomplete_string()).FromJust())</span>
<span class="line">    async_wrap-&gt;MakeCallback(env-&gt;oncomplete_string(), arraysize(argv), argv);</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的逻辑非常复杂和繁琐，主要是利用了 C++ 层的流机制，我们需要梳理清楚它们的关系才能知道整个流程是怎样的，有兴趣的可以看这篇<a href="https://theanarkh.github.io/understand-nodejs/chapter06-C%2B%2B%E5%B1%82/" target="_blank" rel="noopener noreferrer">文章</a>。最终调用 JS 的回调 onWriteComplete 函数，也就是 Writable 的回调，Writable 会继续下一次数据的发送（如果有的话），如此类推。</p><h1 id="node-js-tcp-连接的管理" tabindex="-1"><a class="header-anchor" href="#node-js-tcp-连接的管理"><span>Node.js TCP 连接的管理</span></a></h1><p>完成了数据通信后，我们需要主动关闭连接，以免浪费资源。上一节课讲过 TCP 是全双工的，支持关闭读端 / 写端或者全部关闭（Node.js 中没有单独关闭读端的概念，对端关闭写端就行）。下面我们来具体分析。</p><p>关闭写操作 当发送完数据后，可以通过调用 socket 对象的 end 函数关闭流的写端。看一下 end 的逻辑。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Socket</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">end</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">  stream<span class="token punctuation">.</span><span class="token class-name">Duplex</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> </span>
<span class="line">                                   data<span class="token punctuation">,</span> </span>
<span class="line">                                   encoding<span class="token punctuation">,</span> </span>
<span class="line">                                   callback<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Socket 的 end 是调用的 Duplex 的 end，而 Duplex 的 end 是继承于 Writable 的 end。Writable 的 end 最终会执行 _final 函数（所有数据写到操作系统后）。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Socket</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_final</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShutdownWrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>oncomplete <span class="token operator">=</span> afterShutdown<span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>handle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_handle<span class="token punctuation">;</span></span>
<span class="line">  req<span class="token punctuation">.</span>callback <span class="token operator">=</span> cb<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>_handle<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>_final 中调用了 shutdown 关闭 socket 到写端，对应 C++ 函数为 StreamBase::Shutdown。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">int StreamBase::Shutdown(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {</span>
<span class="line">  Local&lt;Object&gt; req_wrap_obj = args[0].As&lt;Object&gt;();</span>
<span class="line">  return Shutdown(req_wrap_obj);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">int StreamBase::Shutdown(v8::Local&lt;v8::Object&gt; req_wrap_obj) {</span>
<span class="line">  Environment* env = stream_env();</span>
<span class="line">  // 创建一个关闭请求对象，和前面的 ConnectWrap 类似</span>
<span class="line">  ShutdownWrap* req_wrap = CreateShutdownWrap(req_wrap_obj);</span>
<span class="line">  DoShutdown(req_wrap);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">int LibuvStreamWrap::DoShutdown(ShutdownWrap* req_wrap_) {</span>
<span class="line">  LibuvShutdownWrap* req_wrap = static_cast&lt;LibuvShutdownWrap*&gt;(req_wrap_);</span>
<span class="line">  return req_wrap-&gt;Dispatch(uv_shutdown, stream(), AfterUvShutdown);</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最终调用 uv_shutdown 关闭流的写端，关闭完成后，执行 C++ 的回调函数 AfterUvShutdown。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">void LibuvStreamWrap::AfterUvShutdown(uv_shutdown_t* req, int status) {</span>
<span class="line">  LibuvShutdownWrap* req_wrap = static_cast&lt;LibuvShutdownWrap*&gt;(</span>
<span class="line">      LibuvShutdownWrap::from_req(req));</span>
<span class="line">  req_wrap-&gt;Done(status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void StreamReq::Done(int status, const char* error_str) {</span>
<span class="line">  OnDone(status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void ShutdownWrap::OnDone(int status) {</span>
<span class="line">  stream()-&gt;EmitAfterShutdown(this, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void StreamResource::EmitAfterShutdown(ShutdownWrap* w, int status) {</span>
<span class="line">  DebugSealHandleScope handle_scope(v8::Isolate::GetCurrent());</span>
<span class="line">  listener_-&gt;OnStreamAfterShutdown(w, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void ReportWritesToJSStreamListener::OnStreamAfterShutdown(</span>
<span class="line">    ShutdownWrap* req_wrap, int status) {</span>
<span class="line">  OnStreamAfterReqFinished(req_wrap, status);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void ReportWritesToJSStreamListener::OnStreamAfterReqFinished(</span>
<span class="line">    StreamReq* req_wrap, int status) {</span>
<span class="line">  async_wrap-&gt;MakeCallback(env-&gt;oncomplete_string(), arraysize(argv), argv);</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的逻辑比较绕，主要还是 C++ 层的流机制相关，不深究也没关系。C++ 层最终调用了 JS 层的 afterShutdown。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">afterShutdown</span><span class="token punctuation">(</span><span class="token parameter">status<span class="token punctuation">,</span> handle<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token comment">// 拿到 JS socket 对象</span></span>
<span class="line">  <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handle<span class="token punctuation">[</span>owner_symbol<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 执行回调</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Callback may come after call to destroy.</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>destroyed<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 如果读端也不可读了，则销毁socket</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token punctuation">.</span>readable <span class="token operator">||</span> self<span class="token punctuation">.</span>readableEnded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    self<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>销毁</p><p>当一个 socket 不可读也不可写或者出错时， Node.js 内部会调用 destroy 函数销毁 socket，我们也可以主动调用 destroy 销毁 socket，例如如下代码。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们发现 Socket 本身没有 destroy 函数，不过 Socket 继承了 Duplex，来看一下 Duplex 这个函数。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">Duplex</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line">  <span class="token function">Readable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">Writable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Duplex 又继承了 Readable 和 Writable 的能力，但是我们发现 Readable 和 Writable 都有 destroy 函数。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Writable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">destroy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name">Readable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>destroy <span class="token operator">=</span> destroyImpl<span class="token punctuation">.</span>destroy<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么到底调了哪个呢？_stream_duplex.js 中有一个关键的操作。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token comment">// Duplex 继承 Readable 能力</span></span>
<span class="line"><span class="token function">ObjectSetPrototypeOf</span><span class="token punctuation">(</span><span class="token class-name">Duplex</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token class-name">Readable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">ObjectSetPrototypeOf</span><span class="token punctuation">(</span>Duplex<span class="token punctuation">,</span> Readable<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// Duplex 也继承 Writable，但是如果已经实现了则不会覆盖</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> method <span class="token keyword">of</span> <span class="token function">ObjectKeys</span><span class="token punctuation">(</span><span class="token class-name">Writable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Duplex</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token class-name">Duplex</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">Writable</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面代码中可以看到，优先使用的是 Readable 中的 destroy 函数，所以最终调用的是 Readable 的 destroy 函数，我们看下具体的函数实现。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_readableState<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_writableState<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 设置状态</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>w<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    w<span class="token punctuation">.</span>destroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    r<span class="token punctuation">.</span>destroyed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">// 调用子类的 _destroy</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_destroy</span><span class="token punctuation">(</span>err <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 触发 close 事件</span></span>
<span class="line">    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span>emitCloseNT<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>destroy 只是实现了通用逻辑，具体操作由子类（这里是 Socket 对象）的 _destroy 实现资源的销毁。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token class-name">Socket</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_destroy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">exception<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">   <span class="token comment">// 关闭底层 handle  </span></span>
<span class="line">   <span class="token keyword">this</span><span class="token punctuation">.</span>_handle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token keyword">this</span><span class="token punctuation">.</span>_handle <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>_destory 函数调用了 _handle 的 close 函数关闭底层的资源（不知道大家是否还记得 this._handle = null 的作用。），这里的 close 是 HandleWrap 的 close 函数，最终调用了 Libuv 的 uv_close。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">void uv_close(uv_handle_t* handle, uv_close_cb close_cb) {</span>
<span class="line">  switch (handle-&gt;type) {</span>
<span class="line">      case UV_TCP:</span>
<span class="line">        uv__tcp_close((uv_tcp_t*)handle);</span>
<span class="line">        break;</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void uv__tcp_close(uv_tcp_t* handle) {</span>
<span class="line">  uv__stream_close((uv_stream_t*)handle);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">void uv__stream_close(uv_stream_t* handle) {</span>
<span class="line">  if (handle-&gt;io_watcher.fd != -1) {</span>
<span class="line">      uv__close(handle-&gt;io_watcher.fd);</span>
<span class="line">    handle-&gt;io_watcher.fd = -1;</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>前面课程已经分析过就不再具体分析，这里重点提一下 uv__close。uv__close 调用了操作系统的 close 函数关闭 fd，从而开始四次挥手的流程，最终完成连接的关闭。下面是操作系统中关闭一个 TCP socket 的流程。</p><div class="language-c++ line-numbers-mode" data-highlighter="prismjs" data-ext="c++" data-title="c++"><pre><code><span class="line">static void tcp_close(struct sock *sk, int timeout)</span>
<span class="line">{</span>
<span class="line">    // 修改 socket 状态</span>
<span class="line">    tcp_close_state(sk,1);</span>
<span class="line">    // 发送 fin 包，第一次握手</span>
<span class="line">    tcp_send_fin(sk);</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">static int tcp_close_state(struct sock *sk, int dead)</span>
<span class="line">{   </span>
<span class="line">    // 默认状态是关闭</span>
<span class="line">    int ns=TCP_CLOSE;</span>
<span class="line">    // 默认不需要发送fin包</span>
<span class="line">    int send_fin=0;</span>
<span class="line">    switch(sk-&gt;state)</span>
<span class="line">    {   </span>
<span class="line">        case TCP_ESTABLISHED: </span>
<span class="line">            ns=TCP_FIN_WAIT1;</span>
<span class="line">            send_fin=1;</span>
<span class="line">            break;</span>
<span class="line">    }</span>
<span class="line">    // 修改 socket 状态为 TCP_FIN_WAIT1</span>
<span class="line">    tcp_set_state(sk,ns);</span>
<span class="line">    return send_fin;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">static void tcp_send_fin(struct sock *sk)</span>
<span class="line">{</span>
<span class="line">    struct proto *prot =(struct proto *)sk-&gt;prot;</span>
<span class="line">    // dummy_th 保存了本端发送数据给对端时的 TCP 报文，参考 TCP 协议格式</span>
<span class="line">    struct tcphdr *th =(struct tcphdr *)&amp;sk-&gt;dummy_th;</span>
<span class="line">    struct tcphdr *t1;</span>
<span class="line">    struct sk_buff *buff;</span>
<span class="line">    struct device *dev=NULL;</span>
<span class="line">    int tmp;</span>
<span class="line">        </span>
<span class="line">    // 分配内存保存 fin 包的数据</span>
<span class="line">    buff = prot-&gt;wmalloc(sk, MAX_RESET_SIZE,1 , GFP_KERNEL);</span>
<span class="line">    sk-&gt;inuse = 1;</span>
<span class="line">    buff-&gt;sk = sk;</span>
<span class="line">    // 当前已用的大小，一个 TCP 头，内容在下面赋值</span>
<span class="line">    buff-&gt;len = sizeof(*t1);</span>
<span class="line">    // 指向数据部分的内存地址</span>
<span class="line">    t1 =(struct tcphdr *) buff-&gt;data;</span>
<span class="line">    // 构建 IP 头、MAC 头，返回写入的大小字节数</span>
<span class="line">    tmp = prot-&gt;build_header(buff,sk-&gt;saddr, sk-&gt;daddr, &amp;dev,</span>
<span class="line">               IPPROTO_TCP, sk-&gt;opt,</span>
<span class="line">               sizeof(struct tcphdr),sk-&gt;ip_tos,sk-&gt;ip_ttl);</span>
<span class="line">    </span>
<span class="line">    // 指向下一个可以写的地址</span>
<span class="line">    t1 =(struct tcphdr *)((char *)t1 +tmp);</span>
<span class="line">    // 更新已使用的大小</span>
<span class="line">    buff-&gt;len += tmp;</span>
<span class="line">    // 写入 tcp 头的内容</span>
<span class="line">    memcpy(t1, th, sizeof(*t1));</span>
<span class="line">    // 序列号</span>
<span class="line">    t1-&gt;seq = ntohl(sk-&gt;write_seq);</span>
<span class="line">    // 是个 fin 包</span>
<span class="line">    t1-&gt;fin = 1;</span>
<span class="line">    t1-&gt;rst = 0;</span>
<span class="line">    // TCP 头长度</span>
<span class="line">    t1-&gt;doff = sizeof(*t1)/4;</span>
<span class="line">    // 还有数据没有发出去则先入队等待</span>
<span class="line">    if (skb_peek(&amp;sk-&gt;write_queue) != NULL) </span>
<span class="line">    {</span>
<span class="line">        // 放到写队列末尾，等到前面的数据先发出去</span>
<span class="line">        skb_queue_tail(&amp;sk-&gt;write_queue, buff);</span>
<span class="line">    } </span>
<span class="line">    else </span>
<span class="line">    {   // 立刻发出去</span>
<span class="line">        sk-&gt;prot-&gt;queue_xmit(sk, dev, buff, 0);</span>
<span class="line">        // 启动超时重传定时器，超时时间时为 rto</span>
<span class="line">        reset_xmit_timer(sk, TIME_WRITE, sk-&gt;rto);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码修改了连接为关闭状态，并且开始四次挥手的流程。</p><p>TCP 的特性 TCP 协议除了正常的数据通信，还支持非常多的特性。比如单个服务器监听不同类型的地址、多个服务器监听不同类型的地址、Keepalive 机制以及半开关等等。了解这些特性不仅可以帮助我们深入理解网络原理，还能帮助我们解决工作中碰到的问题。</p><p>单个服务器监听不同类型的地址 我们平时使用 TCP 模块时，都是简单地 listen 一个端口 ，然后服务器就启动，但是我们是否了解过 listen 背后的意义呢？下面来具体看看监听不同地址的效果，我们通常通过以下代码启动一个服务器。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 lsof -i:8888 查看一下端口监听的情况。</p><p>tu 12-1</p><p>可以看到红色框里是一个 * 开头的字符串，它表示监听了本机器上所有 IP，也就是说收到 8888 的数据包时，主要目的 IP 是本主机的 IP 都会被处理，比如以下代码。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 下面 IP 改成自己的局域网 IP（Macos 可通过 ifconfig 获取），或改成 127.0.0.1 试试</span></span>
<span class="line">    <span class="token keyword">const</span> socket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;192.168.3.9&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;connect successfully&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        socket<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以发现不管 connect 中的 IP 指定成 192.168.3.9 还是 127.0.0.1，甚至不指定都可以连接成功。那么如果我们监听一个固定的 IP 会怎样呢？</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> socket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;192.168.3.9&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;connect successfully&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        socket<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的例子中我们指定了监听的 IP 为 127.0.0.1，但是 connect 中指定的 IP 为 192.168.3.9 ，执行的时候报错如下。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">Error: connect ECONNREFUSED 192.168.3.9:8888</span>
<span class="line">    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1142:16)</span>
<span class="line">Emitted &#39;error&#39; event on Socket instance at:</span>
<span class="line">    at emitErrorNT (node:internal/streams/destroy:157:8)</span>
<span class="line">    at emitErrorCloseNT (node:internal/streams/destroy:122:3)</span>
<span class="line">    at processTicksAndRejections (node:internal/process/task_queues:83:21) {</span>
<span class="line">  errno: -61,</span>
<span class="line">  code: &#39;ECONNREFUSED&#39;,</span>
<span class="line">  syscall: &#39;connect&#39;,</span>
<span class="line">  address: &#39;192.168.3.9&#39;,</span>
<span class="line">  port: 8888</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么呢？因为我们监听的是 127.0.0.1 ，所以连接时必须是指定 127.0.01 才能连接成功。通过命令可以看到端口监听的情况。</p><p>tu 12-2</p><p>如果去掉 connect 函数的 IP 则可以连接成功，说明不设置 IP 时操作系统默认会选 127.0.0.1（MacOS 下测试情况），反过来，监听 192.168.3.9，connect 时不指定 IP 也会报错。</p><p>所以当我们监听时指定了 IP，连接时也需要指定 IP。因此，当我们发现明明监听了这个端口，但是连接时却报错了，则可以看一下是不是监听了固定的 IP 或者通过 lsof 看看监听的情况。</p><p>多个服务器监听不同类型的地址 SO_REUSEADDR 长期以来，我们都有一个认知，就是不能监听同一个端口。那么真的不能这样做吗？下面我们通过一个例子来分析下。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行以上代码后，我们会看到 Address already in use 的错误。刚才讲过，当监听时不指定 IP 则操作系统会监听所有的 IP，所以上面的代码就相当于有两个 socket 监听了一样的地址，那么当操作系统收到一个连接时应该交给谁处理呢？从报错的情况来看操作系统无法决定，所以会报错。</p><p>tu 12-3</p><p>但是真的不能绑定到同一个端口吗？接下来再看一个例子。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;server1&#39;</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;192.168.3.9&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;192.168.3.9&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;server2&#39;</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上面的代码，我们发现不会报错，通过 lsof 命令看看情况。</p><p>tu 12-4</p><p>可以看到这两个 socket 监听的 IP 是不一样的，这样操作系统收到连接时就可以根据报文的目的 IP 来判断这个包应该给谁处理。以上的代码输出如下。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">server1 192.168.3.9</span>
<span class="line">server2 127.0.0.1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>操作系统的处理如下。</p><p>tu 12-5</p><p>那么如果我们分别监听固定 IP 和全部 IP 会怎样呢？下面来看一下。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;server1&#39;</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;192.168.3.9&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;server2&#39;</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token string">&#39;127.0.0.1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的例子中一个监听了所有 IP，一个监听了具体 IP，可以成功执行。看看 lsof 的输出。</p><p>tu 12-6</p><p>看起来操作系统在这种情况下知道如何分发连接，但真的是这样吗？下面通过另外一个例子看看是否是这样。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">start_server</span><span class="token punctuation">(</span>__uint32_t host<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> host<span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    ERROR<span class="token operator">:</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;bind socket error: %s(errno: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">   <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 gcc test.c &amp;&amp; ./a.out 编译执行上面的代码报错如下。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">bind socket error: Address already in use(errno: 48)</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>以上代码也是绑定了所有 IP 和具体 IP，为什么还会报错呢？这和 Node.js 的实现有什么区别？我们再改一下</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">start_server</span><span class="token punctuation">(</span>__uint32_t host<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">int</span> on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 设置 SO_REUSEADDR</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>on<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> host<span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    ERROR<span class="token operator">:</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;bind socket error: %s(errno: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">   <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这一次的代码可以执行成功，区别是设置了 SO_REUSEADDR 属性（Node.js 是默认设置的）。这是干什么的呢？</p><p>TIME_WAIT 状态的端口可以快速复用，否则需要等待 2 * MSL（Maximum Segment Lifetime） 时间。 可以同时绑定全部 IP 和具体 IP。</p><blockquote><p>第二点在 MacOS 下可以，Linux 下不支持，Linux 文档的描述如下。</p></blockquote><p>When the listening socket is bound to INADDR_ANY with a specific port then it is not possible to bind to this port for any local address.</p><p>文档说了，如果端口绑定到了所有 IP，就不能再绑定具体的 IP 了。</p><p>正是因为 Node.js 默认设置了 SO_REUSEADDR，所以监听全部 IP 和具体 IP 的代码才能成功运行，否则操作系统收到具体 IP 的包时，还是无法决定给监听了具体 IP 的 socket 还是监听了全部 IP 的 socket 处理（虽然理论上可以选择给具体 IP，但是操作系统实现上并不是这样）。另外，除了通过 IP 因子外，通过协议也可以实现监听不同的端口。比如下面的例子。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> dgram <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;dgram&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">&#39;udp4&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;message&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是 lsof -i:8888 命令的输出。</p><p>tu 12-7</p><p>从中可以看到监听的协议是不一样的，这样操作系统就可以根据 IP 报文的协议字段进行分发。</p><p>SO_REUSEPORT 刚才讲 SO_REUSEADDR 的第一个例子中，我们创建了两个 socket，这两个 socket 都监听了同一个端口和全部 IP，因为操作系统无法决定把收到的包给谁，所以导致了报错。但是真的不能监听同一个地址吗（IP 和端口都一样）？我们一起来看一个例子（Linux 下运行）。</p><div class="language-c line-numbers-mode" data-highlighter="prismjs" data-ext="c" data-title="c"><pre><code><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;errno.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">start_server</span><span class="token punctuation">(</span>__uint32_t host<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">int</span> listenfd<span class="token punctuation">,</span> connfd<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> servaddr<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">int</span> on <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// 去掉试试</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEPORT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>on<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> host<span class="token punctuation">;</span></span>
<span class="line">    servaddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>servaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servaddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">goto</span> ERROR<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    ERROR<span class="token operator">:</span></span>
<span class="line">        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;bind socket error: %s(errno: %d)\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">   <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译执行上面代码可以执行成功。这是为什么呢？因为 SO_REUSEPORT 在底层实现了新的分发机制，虽然两个 socket 监听的地址是一样的，但是操作系统收到一个包的时候会基于某种算法把请求分发到某一个 socket 中。Node.js 中因为操作系统兼容性问题没有支持 SO_REUSEPORT，但是我们可以了解它的使用，必要时也可以通过 Addon 的方式实现这个能力。</p><p>总的来说，只要操作系统实现上能判断一个包给谁处理，那么这个地址就可以被绑定，但是不同操作系统的实现间可能有差别，我们只需要了解这些情况就行，碰到问题的时候具体分析。实现多个服务器监听同一个端口可以使得应用可以在多个进程中共同处理连接，这样可以利用多核提高处理效率。当然，实现多个进程监听同一个端口的技术很多，这里只是其中一种，后面 Cluster 课程我们会详细介绍。</p><p>Keepalive 接下来看一下 TCP 协议的另一个特性 Keepalive。因为 TCP 是面向连接的，前面讲过连接的本质就是在两端的内存中保存了一个数据结构记录这个关系，当不再使用这个连接时需要显式断开才能释放对应的内存。</p><p>但是很多时候可能会出现一些不是我们预期的情况，比如我们 HTTP 长连接或者 WebSocket 的场景下，我们希望这个 TCP 连接能保持一段时间甚至一直保持。如果这时候某一端断网了，那么另一端就会一直保持这个 TCP 连接，因为它无法知道对端已经无法工作了，这就导致了内存无法释放，同时文件描述符也不会被关闭。</p><p>Keepalive 就是用于解决这个问题的，它可以探测对端是否还存活。当我们给一个 Socket 设置了 Keepalive 后，没有数据通信时操作系统会定时发送心跳检测对端的情况，如果对端有回复 ack 则说明还存活，如果一直没有回复，则达到阈值后操作系统就会自动关闭这个连接。 具体的策略如下。</p><p>多久没有数据包通信，则开始发送探测包（有数据通信时则重置定时器）。 每隔多久发送一次探测包。 发送多少个探测包后，如果还没有回复，则断开连接。 下面看一个例子。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 TCP 服务器</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">setKeepAlive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 启动服务器</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码建立了一个 TCP 连接，并且设置了 10 s 没有数据通信时开始发送心跳包（因为系统兼容性问题，Node.js 只能设置多久没有数据通信后开始发送心跳包）。从下图可以看到 10 s 操作系统发送了第一个心跳包。</p><p>tu 12-8</p><p>Keepalive 机制看起来很好，但是现实情况却很复杂，前面讲到 Keepalive 会在没有数据通信时才会触发，如果两端正在通信，某一端突然断网了，这时候另一端就会触发重试机制而不会触发 Keepalive 机制，这样就会导致操作系统不断地重传数据，直到达到了重传次数的阈值才会关闭连接，白白浪费资源。TCP_USER_TIMEOUT 就是用来解决这个问题的，它设置了数据通信的最大 ack 时长，也就是说当操作系统发送一个包时，对端超过 TCP_USER_TIMEOUT 还没有回复 ack，则连接会被关闭。不过遗憾的是因为系统兼容性问题，无法在 Node.js 里使用TCP_USER_TIMEOUT。</p><p>半开关 前面讲过，TCP 协议是全双工的协议，两端可以同时发送和接收数据。半开关就是可以先关闭一端。比如服务端收到客户端的 fin 包并回复 ack 后就进入了半开关状态，这时候客户端不会发送数据了，但是服务端还可以给客户端发送数据。</p><p>是否需要半开关这个特性要根据具体情况来判断，比如服务器收到了完整的 HTTP 请求报文后，客户端关闭了写端则是正常的，服务器只需要处理完请求后关闭连接就行，而如果收到半个 HTTP 请求报文客户端就关闭了写端，则服务器需要关闭这个异常的连接。下面看一个例子。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 TCP 服务器</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">allowHalfOpen</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 启动服务器</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> socket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;no data yet&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>比如，我们可以看到在上面代码中，客户端连接成功后发送了 no data yet 给服务器并且关闭了写端，因为服务器设置了 allowHalfOpen 为 true，所以不会关闭整个 TCP 连接，1 s 后服务器返回 end 给客户端并关闭写端，从而关闭整个连接。流程如下。</p><p>tu 12-9</p><p>下面看看没有设置 allowHalfOpen 的情况。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 TCP 服务器</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 需要消费数据才能触发 end，然后才会关闭写端</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 启动服务器</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> socket <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;connect&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;no data yet&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>连接成功后客户端发送了 no data yet 并且关闭了写端，因为服务器没有设置 allowHalfOpen（默认为 false），所以服务器也会关闭写端，从而完成四次挥手关闭整个 TCP 连接，1 s 后服务器再执行 end 给客户端发送数据时会触发报错 This socket has been ended by the other party。整体流程如下。</p><p>tu 12-10</p><p>这个行为在后续的版本中有所修改，我们只需要理解半开关的原理就行。</p><p>总结 这节课我们基于上节课讲解的 TCP 基础，进一步学习了 Node.js TCP 数据通信、连接管理和 TCP 的特性。</p><p>在 TCP 连接上，Node.js 通过事件驱动模块实现了数据通信。建立连接后，Node.js 通过注册可读事件等待数据的到来，通过注册可写事件实现数据的发送。因为 TCP 连接是全双工的，所以我们可以选择关闭一端或者全关闭，全关闭的本质就是关闭 TCP 连接。</p><p>此外，我们还介绍了 4 种 TCP 的特性：</p><p>通过监听端口、监听 IP + 端口和监听不同的 IP 等场景介绍了 TCP 中监听不同地址的情况和原理，以后我们碰到相关问题时也可以迎刃而解，比如我们连接某个端口时报了 ECONNREFUSED 错误，但是通过 lsof 又发现监听了这个端口，则可以进一步判断是否监听时指定了 IP。 通过 SO_REUSEADDR 和 SO_REUSEPORT 可以不同程度地实现多个服务器监听同一个端口，尤其是 SO_REUSEPORT 可以直接监听同一个 IP 和端口，使得我们可以在多个进程中共同处理连接，提高效率。 关于 TCP Keepalive 机制，我们需要知道它的作用和使用场景。比如我们实现连接池时，就可以通过 Keepalive 机制探测空闲 socket 的对端是否还存活。 最后是半开关的使用场景，如果我们想在 TCP 协议之上通过 JSON 格式的数据进行通信，客户端就可以通过关闭写端来通知服务器请求报文发送完毕，服务器再通过 JSON.parse 解析收到的数据，然后返回结果。否则，如果我们在一个连接中发送多个请求，服务器需要实现一个解析器来解析一个个请求。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: wupan1030@foxmail.com">sindorei</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/note/assets/app-LHpjaFTr.js" defer></script>
  </body>
</html>
